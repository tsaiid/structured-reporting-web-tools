<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lung-RADS v2022 å ±å‘Šç”¢ç”Ÿå™¨ (v12.0)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <style>
        /* --- åŸºç¤æ¨£å¼èª¿æ•´ --- */
        body { padding-bottom: 100px; }

        /* Sticky Footer */
        .sticky-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: var(--background-color);
            border-top: 1px solid var(--primary);
            box-shadow: 0 -1px 5px rgba(0, 0, 0, 0.15);
            padding: 1rem; z-index: 100;
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0; transform: translateY(100%); visibility: hidden;
        }
        .sticky-footer.visible { opacity: 1; transform: translateY(0); visibility: visible; }
        .footer-container {
            display: flex; justify-content: space-between; align-items: center;
            max-width: 1152px; margin: 0 auto; padding: 0 1rem; gap: 1rem;
        }
        .footer-container button { margin-bottom: 0; }

        /* General UI Components */
        .nested-section { padding-left: 1.5rem; border-left: 3px solid var(--primary); margin-top: 0.5rem; }

        /* éš±è—æ¨£å¼ï¼šä½¿ç”¨ classList æ“ä½œ */
        .hidden { display: none !important; }

        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }

        input.form-input, input[type="number"], input[type="text"], select {
            font-size: 0.9em; padding: 0.2rem 0.4rem; height: auto;
            vertical-align: middle; margin: 0 0.25em; width: auto; display: inline-block;
        }
        input::placeholder { font-size: 0.9em; color: var(--muted-color); }
        input[type="checkbox"], input[type="radio"] { vertical-align: middle; }

        .inline-label-group { display: flex; flex-wrap: wrap; gap: 1rem; align-items: baseline; margin-bottom: var(--pico-spacing); }
        .inline-label-group span { display: inline-flex; align-items: center; gap: 0.5rem; margin-right: 0.5rem; }

        fieldset { margin-bottom: var(--pico-spacing); }
        fieldset legend { font-weight: bold; }
        fieldset label { display: block; margin-bottom: 0.5rem; }
        fieldset span { display: inline-block; margin-right: 1.5rem; }

        .unit-label { color: var(--muted-color); margin-left: 2px; font-size: 0.9em; }

        /* --- Nodule Card Styling --- */
        article.nodule-block {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid var(--muted-border-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            background-color: var(--card-background-color);
            border-radius: var(--border-radius);
            position: relative;
        }

        .nodule-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem; border-bottom: 2px solid var(--muted-border-color);
            padding-bottom: 0.5rem;
        }
        .nodule-title { font-weight: bold; font-size: 1.2em; color: var(--primary); }

        .btn-delete {
            background-color: transparent; border: 1px solid var(--del-color);
            color: var(--del-color); padding: 0.3rem 0.8rem; font-size: 0.8em;
            cursor: pointer; margin-bottom: 0; transition: all 0.2s;
        }
        .btn-delete:hover { background-color: var(--del-color); color: white; border-color: var(--del-color); }

        /* --- Layout: Size (Left) vs Density (Right) --- */
        .nodule-row-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .nodule-size-col {
            flex: 0 0 auto;
            min-width: 200px;
        }
        .nodule-density-col {
            flex: 1 1 auto;
        }

        /* Density Radio Group Styling */
        .density-options-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .density-option-wrapper {
            display: flex;
            flex-direction: column;
        }
        .density-radio-label {
            display: inline-flex; align-items: center; font-weight: normal;
        }

        /* Solid part indentation */
        .solid-part-container {
            margin-top: 0.3rem;
            margin-left: 1.4rem;
            padding: 0.3rem;
            background-color: var(--muted-background-color);
            border-radius: 4px;
            display: inline-block;
        }

        /* Error Styling */
        .input-error {
            border: 2px solid #e53935 !important;
            background-color: #ffebee !important;
            box-shadow: 0 0 5px rgba(229, 57, 53, 0.5);
            transition: all 0.3s ease;
        }

        #modal_output {
            white-space: pre-wrap; word-wrap: break-word;
            background-color: var(--muted-background-color);
            padding: 1rem; border-radius: var(--border-radius);
            font-family: var(--pico-font-family-monospace);
        }

        dialog article { width: 90vw; max-width: 1000px; }

        /* åˆªé™¤ç¢ºèª Modal å°ˆç”¨æ¨£å¼ */
        #delete_modal article {
            max-width: 400px;
            text-align: center;
        }
        .modal-actions {
            display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem;
        }
    </style>
</head>
<body>

    <main class="container">
        <header>
            <h1>Lung-RADS v2022 å ±å‘Šç”¢ç”Ÿå™¨</h1>
            <p>å¡«å¯«ä»¥ä¸‹æ¬„ä½ï¼Œé»æ“Šã€Œè¤‡è£½å ±å‘Šã€æŒ‰éˆ•å³å¯ç”¢ç”Ÿç´”æ–‡å­—å ±å‘Šä¸¦è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚</p>
        </header>

        <article>
            <section>
                <div class="inline-label-group">
                    <span>LDCT Quality:</span>
                    <span><label><input type="radio" name="quality" value="Good" checked> Good</label></span>
                    <span><label><input type="radio" name="quality" value="Acceptable"> Acceptable</label></span>
                    <span><label><input type="radio" name="quality" value="Not Acceptable"> Not Acceptable</label></span>
                </div>

                <div class="inline-label-group">
                    <span>CTDIvol: <input type="text" class="form-input num-only" id="ctdi" placeholder="" style="width: 80px;"><span class="unit-label">mGy</span></span>
                    <span>Total DLP: <input type="text" class="form-input num-only" id="dlp" placeholder="" style="width: 100px;"><span class="unit-label">mGy*cm</span></span>
                </div>

                <div class="inline-label-group">
                    <span>Prior CT Date (Y/M/D): <input type="text" class="form-input" id="prior_date" placeholder="YYYY/MM/DD" style="width: 160px;" oninput="handlePriorDateInput()"></span>
                    <span><label><input type="checkbox" id="no_prior" onchange="togglePriorDate(this.checked)"> No prior chest CT available</label></span>
                </div>
            </section>

            <hr>

            <section>
                <h3>Lung nodule findings related to cancer screening</h3>
                <p><small>è©³ç´°è¦ç¯„è«‹åƒé–± Lung-RADS v2022</small></p>
                <fieldset>
                    <label><input type="checkbox" id="no_nodule"> No lung nodule</label>
                    <label><input type="checkbox" id="benign_features"> Nodule with benign features.</label>
                    <label><input type="checkbox" id="nodule_lt6"> Lung nodule(s) (&lt;6mm) (é¸å¡« SE: <input type="text" class="form-input" id="lt6_se" style="width: 60px;">, IM: <input type="text" class="form-input" id="lt6_im" style="width: 350px; max-width: 80vw;">)</label>
                    <label><input type="checkbox" id="juxtapleural"> Juxtapleural nodule.</label>
                    <label>
                        <input type="checkbox" id="nodule_gte6" onchange="handleNoduleGte6Change(this.checked)">
                        Lung nodule(s) (â‰§6mm or enlarging&gt;1.5mm or newâ‰§4mm)
                    </label>
                </fieldset>
                <div id="nodule_details" class="nested-section hidden">
                    <fieldset>
                        <legend>Total number</legend>
                        <span><label><input type="radio" name="total_nodules" value="1" onchange="updateNoduleCount()"> 1</label></span>
                        <span><label><input type="radio" name="total_nodules" value="2" onchange="updateNoduleCount()"> 2</label></span>
                        <span><label><input type="radio" name="total_nodules" value="3" onchange="updateNoduleCount()"> 3</label></span>
                        <span><label><input type="radio" name="total_nodules" value=">=4" onchange="updateNoduleCount()"> â‰¥4</label></span>
                    </fieldset>
                    <p>è«‹ä¾åºæè¿°æœ€æ‡·ç–‘ä¹‹è‚ºçµç¯€(è‡³å¤š 3 å€‹)</p>

                    <article id="block_n1" class="nodule-block hidden">
                        <div class="nodule-header">
                            <span class="nodule-title">Lung nodule 1</span>
                            <button class="btn-delete" onclick="promptDelete(1)" title="åˆªé™¤æ­¤çµç¯€ä¸¦å¾€ä¸Šéè£œ">ğŸ—‘ åˆªé™¤</button>
                        </div>
                        <input type="checkbox" id="n1_enable" class="hidden">

                        <div class="nodule-row-layout">
                            <div class="nodule-size-col">
                                <label><b>Entire Nodule:</b></label>
                                <div style="margin-top: 0.5rem;">
                                    <input type="text" class="form-input num-only" id="n1_size" style="width: 80px;"> <span class="unit-label">mm</span>
                                </div>
                            </div>
                            <div class="nodule-density-col">
                                <fieldset>
                                    <legend>Density:</legend>
                                    <div class="density-options-group">
                                        <div class="density-option-wrapper">
                                            <label class="density-radio-label">
                                                <input type="radio" name="n1_density" value="non-solid" onchange="toggleSolidPart('n1_solid_container', this.value)"> non-solid
                                            </label>
                                        </div>
                                        <div class="density-option-wrapper">
                                            <label class="density-radio-label">
                                                <input type="radio" name="n1_density" value="part-solid" onchange="toggleSolidPart('n1_solid_container', this.value)"> part-solid
                                            </label>
                                            <div id="n1_solid_container" class="hidden solid-part-container">
                                                <small>Solid Part:</small>
                                                <input type="text" class="form-input num-only" id="n1_solid_part" style="width: 60px;"> <span class="unit-label">mm</span>
                                            </div>
                                        </div>
                                        <div class="density-option-wrapper">
                                            <label class="density-radio-label">
                                                <input type="radio" name="n1_density" value="solid" onchange="toggleSolidPart('n1_solid_container', this.value)"> solid
                                            </label>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>

                        <div class="grid-3">
                            <div>
                                <label>Lobe (SE: <input type="text" class="form-input" id="n1_se" style="width: 50px;">, IM: <input type="text" class="form-input" id="n1_im" style="width: 50px;">)</label>
                                <fieldset id="n1_lobe_group">
                                    <span><label><input type="radio" name="n1_lobe" value="RUL"> RUL</label></span>
                                    <span><label><input type="radio" name="n1_lobe" value="RML"> RML</label></span>
                                    <span><label><input type="radio" name="n1_lobe" value="RLL"> RLL</label></span>
                                    <span><label><input type="radio" name="n1_lobe" value="LUL"> LUL</label></span>
                                    <span><label><input type="radio" name="n1_lobe" value="LLL"> LLL</label></span>
                                </fieldset>
                            </div>
                        </div>

                        <fieldset id="n1_status_group">
                            <legend>Status</legend>
                            <span><label><input type="radio" name="n1_status" value="unchanged"> unchanged</label></span>
                            <span><label><input type="radio" name="n1_status" value="enlarging"> enlarging (&gt;1.5 mm)</label></span>
                            <span><label><input type="radio" name="n1_status" value="newly found"> newly found (â‰§4 mm)</label></span>
                            <span><label><input type="radio" name="n1_status" value="no prior"> No prior chest CT comparison</label></span>
                        </fieldset>
                    </article>

                    <article id="block_n2" class="nodule-block hidden">
                        <div class="nodule-header">
                            <span class="nodule-title">Lung nodule 2</span>
                            <button class="btn-delete" onclick="promptDelete(2)" title="åˆªé™¤æ­¤çµç¯€ä¸¦å¾€ä¸Šéè£œ">ğŸ—‘ åˆªé™¤</button>
                        </div>
                        <input type="checkbox" id="n2_enable" class="hidden">

                        <div class="nodule-row-layout">
                            <div class="nodule-size-col">
                                <label><b>Entire Nodule:</b></label>
                                <div style="margin-top: 0.5rem;">
                                    <input type="text" class="form-input num-only" id="n2_size" style="width: 80px;"> <span class="unit-label">mm</span>
                                </div>
                            </div>
                            <div class="nodule-density-col">
                                <fieldset>
                                    <legend>Density:</legend>
                                    <div class="density-options-group">
                                        <div class="density-option-wrapper">
                                            <label class="density-radio-label">
                                                <input type="radio" name="n2_density" value="non-solid" onchange="toggleSolidPart('n2_solid_container', this.value)"> non-solid
                                            </label>
                                        </div>
                                        <div class="density-option-wrapper">
                                            <label class="density-radio-label">
                                                <input type="radio" name="n2_density" value="part-solid" onchange="toggleSolidPart('n2_solid_container', this.value)"> part-solid
                                            </label>
                                            <div id="n2_solid_container" class="hidden solid-part-container">
                                                <small>Solid Part:</small>
                                                <input type="text" class="form-input num-only" id="n2_solid_part" style="width: 60px;"> <span class="unit-label">mm</span>
                                            </div>
                                        </div>
                                        <div class="density-option-wrapper">
                                            <label class="density-radio-label">
                                                <input type="radio" name="n2_density" value="solid" onchange="toggleSolidPart('n2_solid_container', this.value)"> solid
                                            </label>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>

                        <div class="grid-3">
                            <div>
                                <label>Lobe (SE: <input type="text" class="form-input" id="n2_se" style="width: 50px;">, IM: <input type="text" class="form-input" id="n2_im" style="width: 50px;">)</label>
                                <fieldset id="n2_lobe_group">
                                    <span><label><input type="radio" name="n2_lobe" value="RUL"> RUL</label></span>
                                    <span><label><input type="radio" name="n2_lobe" value="RML"> RML</label></span>
                                    <span><label><input type="radio" name="n2_lobe" value="RLL"> RLL</label></span>
                                    <span><label><input type="radio" name="n2_lobe" value="LUL"> LUL</label></span>
                                    <span><label><input type="radio" name="n2_lobe" value="LLL"> LLL</label></span>
                                </fieldset>
                            </div>
                        </div>

                        <fieldset id="n2_status_group">
                            <legend>Status</legend>
                            <span><label><input type="radio" name="n2_status" value="unchanged"> unchanged</label></span>
                            <span><label><input type="radio" name="n2_status" value="enlarging"> enlarging (&gt;1.5 mm)</label></span>
                            <span><label><input type="radio" name="n2_status" value="newly found"> newly found (â‰§4 mm)</label></span>
                            <span><label><input type="radio" name="n2_status" value="no prior"> No prior chest CT comparison</label></span>
                        </fieldset>
                    </article>

                    <article id="block_n3" class="nodule-block hidden">
                        <div class="nodule-header">
                            <span class="nodule-title">Lung nodule 3</span>
                            <button class="btn-delete" onclick="promptDelete(3)" title="åˆªé™¤æ­¤çµç¯€ä¸¦å¾€ä¸Šéè£œ">ğŸ—‘ åˆªé™¤</button>
                        </div>
                        <input type="checkbox" id="n3_enable" class="hidden">

                        <div class="nodule-row-layout">
                            <div class="nodule-size-col">
                                <label><b>Entire Nodule:</b></label>
                                <div style="margin-top: 0.5rem;">
                                    <input type="text" class="form-input num-only" id="n3_size" style="width: 80px;"> <span class="unit-label">mm</span>
                                </div>
                            </div>
                            <div class="nodule-density-col">
                                <fieldset>
                                    <legend>Density:</legend>
                                    <div class="density-options-group">
                                        <div class="density-option-wrapper">
                                            <label class="density-radio-label">
                                                <input type="radio" name="n3_density" value="non-solid" onchange="toggleSolidPart('n3_solid_container', this.value)"> non-solid
                                            </label>
                                        </div>
                                        <div class="density-option-wrapper">
                                            <label class="density-radio-label">
                                                <input type="radio" name="n3_density" value="part-solid" onchange="toggleSolidPart('n3_solid_container', this.value)"> part-solid
                                            </label>
                                            <div id="n3_solid_container" class="hidden solid-part-container">
                                                <small>Solid Part:</small>
                                                <input type="text" class="form-input num-only" id="n3_solid_part" style="width: 60px;"> <span class="unit-label">mm</span>
                                            </div>
                                        </div>
                                        <div class="density-option-wrapper">
                                            <label class="density-radio-label">
                                                <input type="radio" name="n3_density" value="solid" onchange="toggleSolidPart('n3_solid_container', this.value)"> solid
                                            </label>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>

                        <div class="grid-3">
                            <div>
                                <label>Lobe (SE: <input type="text" class="form-input" id="n3_se" style="width: 50px;">, IM: <input type="text" class="form-input" id="n3_im" style="width: 50px;">)</label>
                                <fieldset id="n3_lobe_group">
                                    <span><label><input type="radio" name="n3_lobe" value="RUL"> RUL</label></span>
                                    <span><label><input type="radio" name="n3_lobe" value="RML"> RML</label></span>
                                    <span><label><input type="radio" name="n3_lobe" value="RLL"> RLL</label></span>
                                    <span><label><input type="radio" name="n3_lobe" value="LUL"> LUL</label></span>
                                    <span><label><input type="radio" name="n3_lobe" value="LLL"> LLL</label></span>
                                </fieldset>
                            </div>
                        </div>

                        <fieldset id="n3_status_group">
                            <legend>Status</legend>
                            <span><label><input type="radio" name="n3_status" value="unchanged"> unchanged</label></span>
                            <span><label><input type="radio" name="n3_status" value="enlarging"> enlarging (&gt;1.5 mm)</label></span>
                            <span><label><input type="radio" name="n3_status" value="newly found"> newly found (â‰§4 mm)</label></span>
                            <span><label><input type="radio" name="n3_status" value="no prior"> No prior chest CT comparison</label></span>
                        </fieldset>
                    </article>

                    <article id="block_else" class="nodule-block hidden">
                        <label class="nodule-title">Lung nodules else</label>
                        <hr>
                        <fieldset>
                            <span><label><input type="checkbox" id="else_rul"> RUL</label></span>
                            <span><label><input type="checkbox" id="else_rml"> RML</label></span>
                            <span><label><input type="checkbox" id="else_rll"> RLL</label></span>
                            <span><label><input type="checkbox" id="else_lul"> LUL</label></span>
                            <span><label><input type="checkbox" id="else_lll"> LLL</label></span>
                        </fieldset>
                        <div class="grid-2">
                            <label>SE: <input type="text" class="form-input" id="else_se"></label>
                            <label>IM: <input type="text" class="form-input" id="else_im"></label>
                        </div>
                    </article>
                </div>
            </section>

            <section>
                <fieldset>
                    <legend>Airway nodule</legend>
                    <label><input type="checkbox" id="airway_subsegmental"> Subsegmental (Category 2)</label>
                    <label>
                        <input type="checkbox" id="airway_proximal" onchange="clearAirwayChildren(this.checked)">
                        Segmental or more proximal
                    </label>
                    <div id="airway_proximal_details" class="nested-section">
                        <label><input type="checkbox" id="airway_secretions" onchange="updateAirwayParent()"> Favors secretions (Category 2)</label>
                        <label><input type="checkbox" id="airway_baseline" onchange="updateAirwayParent()"> At baseline (Category 4A)</label>
                        <label><input type="checkbox" id="airway_stable" onchange="updateAirwayParent()"> Stable or growing (Category 4B)</label>
                    </div>
                </fieldset>
            </section>

            <section>
                <fieldset>
                    <legend>Atypical pulmonary cyst</legend>
                    <label>
                        <input type="checkbox" id="cyst_3"> Category 3. Lobe: (SE: <input type="text" class="form-input" id="cyst_3_se" style="width: 50px;">, IM: <input type="text" class="form-input" id="cyst_3_im" style="width: 50px;">)
                        <span class="lobe-checkbox-container">
                            <span><label><input type="checkbox" id="cyst_3_rul"> RUL</label></span>
                            <span><label><input type="checkbox" id="cyst_3_rml"> RML</label></span>
                            <span><label><input type="checkbox" id="cyst_3_rll"> RLL</label></span>
                            <span><label><input type="checkbox" id="cyst_3_lul"> LUL</label></span>
                            <span><label><input type="checkbox" id="cyst_3_lll"> LLL</label></span>
                        </span>
                    </label>
                    <label>
                        <input type="checkbox" id="cyst_4a"> Category 4A. Lobe: (SE: <input type="text" class="form-input" id="cyst_4a_se" style="width: 50px;">, IM: <input type="text" class="form-input" id="cyst_4a_im" style="width: 50px;">)
                        <span class="lobe-checkbox-container">
                            <span><label><input type="checkbox" id="cyst_4a_rul"> RUL</label></span>
                            <span><label><input type="checkbox" id="cyst_4a_rml"> RML</label></span>
                            <span><label><input type="checkbox" id="cyst_4a_rll"> RLL</label></span>
                            <span><label><input type="checkbox" id="cyst_4a_lul"> LUL</label></span>
                            <span><label><input type="checkbox" id="cyst_4a_lll"> LLL</label></span>
                        </span>
                    </label>
                    <label>
                        <input type="checkbox" id="cyst_4b"> Category 4B. Lobe: (SE: <input type="text" class="form-input" id="cyst_4b_se" style="width: 50px;">, IM: <input type="text" class="form-input" id="cyst_4b_im" style="width: 50px;">)
                        <span class="lobe-checkbox-container">
                            <span><label><input type="checkbox" id="cyst_4b_rul"> RUL</label></span>
                            <span><label><input type="checkbox" id="cyst_4b_rml"> RML</label></span>
                            <span><label><input type="checkbox" id="cyst_4b_rll"> RLL</label></span>
                            <span><label><input type="checkbox" id="cyst_4b_lul"> LUL</label></span>
                            <span><label><input type="checkbox" id="cyst_4b_lll"> LLL</label></span>
                        </span>
                    </label>
                </fieldset>
            </section>

            <label><input type="checkbox" id="metastases"> The pattern of lung nodules has a higher probability of metastases</label>
            <hr>

            <section>
                <h3>Other Lung Findings (é¸å¡«)</h3>
                <fieldset>
                    <span><label><input type="checkbox" id="other_emphysema"> Emphysema</label></span>
                    <span><label><input type="checkbox" id="other_bronchiectasis"> Bronchiectasis</label></span>
                    <span><label><input type="checkbox" id="other_bronchitis"> Bronchitis/bronchiolitis</label></span>
                    <span><label><input type="checkbox" id="other_treeinbud"> Tree-in-bud pattern</label></span>
                    <span><label><input type="checkbox" id="other_centrilobular"> Centrilobular nodules</label></span>
                    <span><label><input type="checkbox" id="other_tb"> Old pulmonary TB</label></span>
                    <span><label><input type="checkbox" id="other_ild"> Interstitial lung disease (ILD)</label></span>
                    <span><label><input type="checkbox" id="other_other_lung_check"> Other <input type="text" class="form-input" id="other_other_lung_text" placeholder="..." style="width: 200px;"></label></span>
                </fieldset>
            </section>
            <section class="inline-inputs">
                <h3>Other Findings (é¸å¡«)</h3>
                <label>Enlarged lymph nodes, location <input type="text" class="form-input" id="other_lymph" placeholder="..."></label>
                <label>Coronary artery calcification <input type="text" class="form-input" id="other_coronary" placeholder="..."></label>
                <label>Other significant abnormal chest findings <input type="text" class="form-input" id="other_chest" placeholder="..."></label>
                <label>Other significant abnormal abdominal or neck findings <input type="text" class="form-input" id="other_abnormal" placeholder="..."></label>
            </section>
            <hr>
            <section>
                <h3>Overall recommendation</h3>
                <fieldset>
                    <legend>Lung-RADS v2022 Category Descriptor</legend>
                    <label><input type="radio" name="category" value="0" onchange="handleCategoryChange()"> Category 0: Incomplete.</label>
                    <div id="cat_0_details" class="nested-section">
                        <label><input type="checkbox" id="cat_0_prior" onchange="updateCat0Radio()"> Prior chest CT examination being located for comparison.</label>
                        <label><input type="checkbox" id="cat_0_unevaluated" onchange="updateCat0Radio()"> Part or all of lungs cannot be evaluated.</label>
                        <label><input type="checkbox" id="cat_0_inflammatory" onchange="updateCat0Radio()"> Findings suggestive of an inflammatory or infectious process.</label>
                    </div>
                    <label><input type="radio" name="category" value="1" onchange="handleCategoryChange()"> Category 1: Negative.</label>
                    <label><input type="radio" name="category" value="2" onchange="handleCategoryChange()"> Category 2: Benign - Based on imaging features or indolent behavior.</label>
                    <label><input type="radio" name="category" value="3" onchange="handleCategoryChange()"> Category 3: Probably Benign - Based on imaging features or behavior.</label>
                    <label><input type="radio" name="category" value="4A" onchange="handleCategoryChange()"> Category 4A: Suspicious.</label>
                    <label><input type="radio" name="category" value="4B" onchange="handleCategoryChange()"> Category 4B: Very suspicious.</label>
                    <label><input type="radio" name="category" value="4X" onchange="handleCategoryChange()"> Category 4X: Category 3 or 4 nodules with additional features or imaging findings that increase suspicion for lung cancer.</label>
                </fieldset>
            </section>
            <hr>
            <section>
                <h3>(é¸å¡«)</h3>
                <label><input type="checkbox" id="modifier_s"> Modifier S: May add to category 0-4 for clinically significant or potentially clinically significant findings unrelated to lung cancer.</label>
                <label><input type="checkbox" id="refer_opd"> è«‹è‡³é–€è¨ºå°±è¨º</label>
            </section>
        </article>
    </main>

    <footer class="sticky-footer" id="sticky-footer">
        <div class="footer-container">
            <strong>æº–å‚™å¥½å¾Œé»æ“Šè¤‡è£½</strong>
            <div>
                <button id="copy_simple_button" onclick="validateAndCopy('simple')" class="secondary">
                    è¤‡è£½ç°¡æ˜“å ±å‘Š
                </button>
                <button id="copy_button" onclick="validateAndCopy('full')">
                    è¤‡è£½å®Œæ•´å ±å‘Š
                </button>
            </div>
        </div>
    </footer>

    <dialog id="report_modal" onclick="closeModalOnBackdrop(event)">
        <article>
            <header>
                <a href="#close" aria-label="Close" class="close" data-target="report_modal" onclick="toggleModal(event)"></a>
                <span id="modal_title">å ±å‘Šå…§å®¹ (å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿)</span>
            </header>
            <pre id="modal_output"></pre>
            <footer>
                <button data-target="report_modal" onclick="toggleModal(event)">é—œé–‰</button>
            </footer>
        </article>
    </dialog>

    <dialog id="delete_modal" onclick="closeModalOnBackdrop(event)">
        <article>
            <header>ç¢ºèªåˆªé™¤</header>
            <p>ç¢ºå®šè¦åˆªé™¤æ­¤çµç¯€å—ï¼Ÿ<br>å¾Œé¢çš„çµç¯€è³‡æ–™å°‡æœƒå¾€å‰éè£œã€‚</p>
            <div class="modal-actions">
                <button class="secondary" onclick="closeModal('delete_modal')">å–æ¶ˆ</button>
                <button class="contrast" onclick="confirmDelete()">ç¢ºå®šåˆªé™¤</button>
            </div>
        </article>
    </dialog>

    <script>
        // --- A. è¼”åŠ©å‡½æ•¸ ---
        const $ = id => document.getElementById(id);
        const getValue = id => $(id).value.trim();
        const isChecked = id => $(id).checked;
        const getRadio = name => document.querySelector(`input[name="${name}"]:checked`)?.value || "";

        const cb = (id, text) => `${isChecked(id) ? '[+]' : '[ ]'} ${text}\n`;
        const rb = (name, value, text) => `${getRadio(name) === value ? '[+]' : '[ ]'} ${text}\n`;
        const cb_inline = (id, text) => `${isChecked(id) ? '[+]' : '[ ]'} ${text}`;

        const txt = (id, prefix = '', suffix = '') => {
            const val = getValue(id);
            return `${prefix}${val || '_'}${suffix}`;
        };
        const cb_se_im = (id_check, text, id_se, id_im, isSimple) => {
            if (isSimple && !isChecked(id_check)) return "";
            if (isChecked(id_check)) {
                const se = getValue(id_se) ? ` SE: ${getValue(id_se)}` : ' SE: _';
                const im = getValue(id_im) ? `, IM: ${getValue(id_im)}` : ', IM: _';
                return `[+] ${text} (${se}${im})\n`;
            }
            return `[ ] ${text} (é¸å¡« SE: , IM:  )\n`;
        };

        // æ•¸å­—è¼¸å…¥é™åˆ¶
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('num-only')) {
                let val = e.target.value;
                val = val.replace(/[^0-9.]/g, '');
                const parts = val.split('.');
                if (parts.length > 2) {
                    val = parts[0] + '.' + parts.slice(1).join('');
                }
                e.target.value = val;
            }
        });

        // --- B. å‹•æ…‹ UI é‚è¼¯ ---
        function toggleSection(elementId, show) {
            const el = $(elementId);
            if (show) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        // æ–°å¢ï¼šè™•ç† Lung nodule(s) (>=6mm) å‹¾é¸é‚è¼¯
        function handleNoduleGte6Change(isChecked) {
            toggleSection('nodule_details', isChecked);
            if (isChecked) {
                // å¦‚æœå‹¾é¸ä½†æ²’æœ‰é¸ Total numberï¼Œé è¨­é¸ 1
                const radio = document.querySelector('input[name="total_nodules"]:checked');
                if (!radio) {
                    const r1 = document.querySelector('input[name="total_nodules"][value="1"]');
                    if (r1) {
                        r1.checked = true;
                        updateNoduleCount();
                    }
                }
            } else {
                // å–æ¶ˆå‹¾é¸æ™‚ï¼Œæ˜¯å¦è¦æ¸…ç©º Total number? æ ¹æ“šéœ€æ±‚1ï¼Œå®Œæ•´å ±å‘Šè¦è¼¸å‡ºï¼Œæ‰€ä»¥å¯èƒ½ä¸éœ€è¦æ¸…ç©ºè³‡æ–™ï¼Œ
                // ä½†æ ¹æ“šéœ€æ±‚2 (åˆªé™¤æœ€å¾Œä¸€é¡†æ™‚)ï¼Œæ˜¯æœƒè¢«æ¸…ç©ºçš„ã€‚
                // é€™è£¡åƒ…åšé¡¯ç¤ºåˆ‡æ›ï¼Œä¸å¼·åˆ¶æ¸…ç©ºè³‡æ–™ï¼Œä¿ç•™æ“ä½œå½ˆæ€§ã€‚
            }
        }

        function toggleSolidPart(containerId, densityValue) {
            const container = $(containerId);
            if (densityValue === 'part-solid') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function updateAirwayParent() {
            $('airway_proximal').checked = isChecked('airway_secretions') || isChecked('airway_baseline') || isChecked('airway_stable');
        }

        function clearAirwayChildren(parentIsChecked) {
            if (!parentIsChecked) {
                $('airway_secretions').checked = false;
                $('airway_baseline').checked = false;
                $('airway_stable').checked = false;
            }
        }

        function handleCategoryChange() {
            if (getRadio('category') !== '0') {
                $('cat_0_prior').checked = false;
                $('cat_0_unevaluated').checked = false;
                $('cat_0_inflammatory').checked = false;
            }
        }

        function updateCat0Radio() {
            if (isChecked('cat_0_prior') || isChecked('cat_0_unevaluated') || isChecked('cat_0_inflammatory')) {
                document.querySelector('input[name="category"][value="0"]').checked = true;
            }
        }

        function updateNoduleCount() {
            const val = getRadio('total_nodules');
            const show = (id, enable) => {
                const el = $(id);
                const checkId = id.replace('block_', '') + '_enable';
                const checkEl = $(checkId);

                if (enable) {
                    el.classList.remove('hidden');
                    if (checkEl) checkEl.checked = true;
                } else {
                    el.classList.add('hidden');
                    if (checkEl) checkEl.checked = false;
                }
            };

            let count = 0;
            if (val === '1') count = 1;
            if (val === '2') count = 2;
            if (val === '3') count = 3;
            if (val === '>=4') count = 4;

            show('block_n1', count >= 1);
            show('block_n2', count >= 2);
            show('block_n3', count >= 3);
            show('block_else', count >= 4);
        }

        // --- åˆªé™¤åŠŸèƒ½ ---
        let noduleToDelete = null;

        function promptDelete(index) {
            noduleToDelete = index;
            openModal('delete_modal');
        }

        function confirmDelete() {
            if (noduleToDelete === null) return;
            const index = noduleToDelete;
            closeModal('delete_modal');

            const radio = document.querySelector('input[name="total_nodules"]:checked');
            if (!radio) return;

            let currentCountStr = radio.value;
            let currentCount = 0;
            if(currentCountStr === '1') currentCount = 1;
            else if(currentCountStr === '2') currentCount = 2;
            else if(currentCountStr === '3') currentCount = 3;
            else if(currentCountStr === '>=4') currentCount = 4;

            // Shift Data
            for (let i = index; i < 3; i++) {
                let next = i + 1;
                $(`n${i}_size`).value = $(`n${next}_size`).value;
                $(`n${i}_solid_part`).value = $(`n${next}_solid_part`).value;
                $(`n${i}_se`).value = $(`n${next}_se`).value;
                $(`n${i}_im`).value = $(`n${next}_im`).value;

                let nextDensity = getRadio(`n${next}_density`);
                if(nextDensity) {
                    let r = document.querySelector(`input[name="n${i}_density"][value="${nextDensity}"]`);
                    if(r) r.checked = true;
                    toggleSolidPart(`n${i}_solid_container`, nextDensity);
                } else {
                    document.querySelectorAll(`input[name="n${i}_density"]`).forEach(el => el.checked = false);
                    toggleSolidPart(`n${i}_solid_container`, '');
                }

                let nextLobe = getRadio(`n${next}_lobe`);
                if(nextLobe) {
                    let r = document.querySelector(`input[name="n${i}_lobe"][value="${nextLobe}"]`);
                    if(r) r.checked = true;
                } else {
                    document.querySelectorAll(`input[name="n${i}_lobe"]`).forEach(el => el.checked = false);
                }

                let nextStatus = getRadio(`n${next}_status`);
                if(nextStatus) {
                    let r = document.querySelector(`input[name="n${i}_status"][value="${nextStatus}"]`);
                    if(r) r.checked = true;
                } else {
                    document.querySelectorAll(`input[name="n${i}_status"]`).forEach(el => el.checked = false);
                }
            }

            // Clear Last active
            let clearIndex = currentCount;
            if (currentCount >= 4) clearIndex = 3;

            if (clearIndex <= 3) {
                 $(`n${clearIndex}_size`).value = '';
                 $(`n${clearIndex}_solid_part`).value = '';
                 $(`n${clearIndex}_se`).value = '';
                 $(`n${clearIndex}_im`).value = '';
                 document.querySelectorAll(`input[name="n${clearIndex}_density"]`).forEach(el => el.checked = false);
                 toggleSolidPart(`n${clearIndex}_solid_container`, '');
                 document.querySelectorAll(`input[name="n${clearIndex}_lobe"]`).forEach(el => el.checked = false);
                 document.querySelectorAll(`input[name="n${clearIndex}_status"]`).forEach(el => el.checked = false);
            }

            // Logic for deleting last nodule (Requirement 2)
            if (currentCount === 1) {
                // 1. Uncheck total number radios
                document.querySelectorAll('input[name="total_nodules"]').forEach(el => el.checked = false);
                // 2. Uncheck Lung nodule(s) (>=6mm...)
                const mainCheck = $('nodule_gte6');
                if (mainCheck) {
                    mainCheck.checked = false;
                    handleNoduleGte6Change(false); // Helper to hide section
                }
                // 3. Explicitly hide N1 block (updateNoduleCount relies on radio, so manual hide here)
                $('block_n1').classList.add('hidden');
                $('n1_enable').checked = false;

            } else {
                let newCount = currentCount - 1;
                let radioVal = String(newCount);
                if (newCount >= 4) radioVal = '>=4';

                const r = document.querySelector(`input[name="total_nodules"][value="${radioVal}"]`);
                if(r) {
                    r.checked = true;
                    updateNoduleCount();
                }
            }

            autoCalculateCategory();
            noduleToDelete = null;
        }

        function handlePriorDateInput() {
            const hasText = getValue('prior_date').length > 0;
            const noPriorCheckbox = $('no_prior');

            if (hasText) {
                noPriorCheckbox.checked = false;
                noPriorCheckbox.disabled = true;
            } else {
                noPriorCheckbox.disabled = false;
            }
            updateNoduleStatusBasedOnPrior(hasText);
        }

        function togglePriorDate(isNoPriorChecked) {
            const priorDateInput = $('prior_date');
            if (isNoPriorChecked) {
                priorDateInput.value = '';
                priorDateInput.disabled = true;
                updateNoduleStatusBasedOnPrior(false, true);
            } else {
                priorDateInput.disabled = false;
                updateNoduleStatusBasedOnPrior(false, false);
            }
        }

        function updateNoduleStatusBasedOnPrior(hasDate, isNoPriorChecked = false) {
            for (let i = 1; i <= 3; i++) {
                const noPriorRadio = document.querySelector(`input[name="n${i}_status"][value="no prior"]`);
                if (!noPriorRadio) continue;

                if (hasDate) {
                    noPriorRadio.disabled = true;
                    if (noPriorRadio.checked) noPriorRadio.checked = false;
                } else {
                    if (isNoPriorChecked || !getValue('prior_date')) {
                         noPriorRadio.disabled = false;
                         const anyChecked = document.querySelector(`input[name="n${i}_status"]:checked`);
                         if (!anyChecked) noPriorRadio.checked = true;
                    } else {
                        noPriorRadio.disabled = false;
                    }
                }
            }
        }

        // Modal è¼”åŠ©
        const openModal = (target) => $(target)?.showModal();
        const closeModal = (target) => $(target)?.close();
        const toggleModal = (event) => {
            event.preventDefault();
            const modalId = event.currentTarget.dataset.target;
            const modal = $(modalId);
            modal.open ? closeModal(modalId) : openModal(modalId);
        };

        function closeModalOnBackdrop(event) {
            if (event.target.tagName === 'DIALOG') {
                event.target.close();
            }
        }

        window.onscroll = function() {
            const footer = $('sticky-footer');
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 50) {
                footer.classList.add('visible');
            } else {
                footer.classList.remove('visible');
            }
        };

        // --- C. é©—è­‰èˆ‡å ±å‘Šç”¢ç”Ÿ ---

        function validateForm() {
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

            let errors = [];

            if (!getValue('ctdi')) errors.push({id: 'ctdi'});
            if (!getValue('dlp')) errors.push({id: 'dlp'});

            const priorDate = getValue('prior_date');
            const noPrior = isChecked('no_prior');
            if (!priorDate && !noPrior) {
                errors.push({id: 'prior_date'});
            }

            if (isChecked('nodule_gte6')) {
                const totalNodules = getRadio('total_nodules');
                let count = 0;
                if(totalNodules === '1') count = 1;
                else if(totalNodules === '2') count = 2;
                else if(totalNodules === '3') count = 3;
                else if(totalNodules === '>=4') count = 3;

                for (let i = 1; i <= count; i++) {
                    if (!getValue(`n${i}_size`)) errors.push({id: `n${i}_size`});

                    const density = getRadio(`n${i}_density`);
                    if (density === 'part-solid') {
                        if (!getValue(`n${i}_solid_part`)) errors.push({id: `n${i}_solid_part`});
                    }
                    if (!getRadio(`n${i}_lobe`)) errors.push({id: `n${i}_lobe_group`});
                    if (!getRadio(`n${i}_status`)) errors.push({id: `n${i}_status_group`});
                }
            }

            if (errors.length > 0) {
                const firstId = errors[0].id;
                const el = $(firstId);
                errors.forEach(e => {
                    const elem = $(e.id);
                    if(elem) elem.classList.add('input-error');
                });
                if(el) {
                    el.scrollIntoView({behavior: 'smooth', block: 'center'});
                    if(el.tagName === 'INPUT') el.focus();
                }
                return false;
            }
            return true;
        }

        function validateAndCopy(type) {
            if (!validateForm()) return;
            if (type === 'full') generateAndCopyFull();
            else generateAndCopySimple();
        }

        // --- Report Generation Logic (Modified for Req 1) ---
        // Helper to get formatted text for a single nodule (populated or empty)
        function generateNoduleText(n, isSimple) {
            const enabled = isChecked(`n${n}_enable`);

            // å¦‚æœæ˜¯ç°¡æ˜“å ±å‘Šï¼Œæœªå•Ÿç”¨å‰‡ä¸é¡¯ç¤º
            if (isSimple && !enabled) return "";

            // å¦‚æœæ˜¯å®Œæ•´å ±å‘Šï¼Œç„¡è«–æ˜¯å¦å•Ÿç”¨éƒ½é¡¯ç¤ºï¼Œè‹¥æœªå•Ÿç”¨å‰‡é¡¯ç¤ºç©ºç™½æ¨¡æ¿

            // æª¢æŸ¥è©² Nodule æ˜¯å¦æœ‰è³‡æ–™è¢«å¡«å¯«/å•Ÿç”¨ (å¦‚æœæ˜¯å®Œæ•´å ±å‘Šä¸”æœªå•Ÿç”¨ï¼Œæˆ‘å€‘è¦çµ¦ç©ºç™½æ¨¡æ¿)
            const isPopulated = enabled;

            // Header line
            let text = `  ${isPopulated ? '[+]' : '[ ]'} Lung nodule ${n} (size, character and location)\n`;

            // Entire Nodule
            text += `    Entire Nodule: ${isPopulated ? txt(`n${n}_size`, '', ' mm') : '_ mm'}\n`;

            // Density
            const density = isPopulated ? getRadio(`n${n}_density`) : '';
            text += `    Density: ${density === 'non-solid' ? '[+]' : '[ ]'} non-solid `;

            // Part-solid
            let partSolidText = ` ${density === 'part-solid' ? '[+]' : '[ ]'} part-solid`;
            if (density === 'part-solid') {
                partSolidText += ` (Solid Part: ${txt(`n${n}_solid_part`, '', ' mm')}) `;
            } else {
                partSolidText += ` (Solid Part: ___ mm) `;
            }
            text += partSolidText;

            // Solid
            text += `${density === 'solid' ? '[+]' : '[ ]'} solid\n`;

            // Lobe
            text += `    Lobe: (SE:${isPopulated ? txt(`n${n}_se`) : '_'}, IM:${isPopulated ? txt(`n${n}_im`) : '_'}) `;
            text += `${isPopulated ? rb(`n${n}_lobe`, 'RUL', 'RUL') : '[ ] RUL'}`;
            text = text.trimEnd() + ` ${isPopulated ? rb(`n${n}_lobe`, 'RML', 'RML') : '[ ] RML'}`;
            text = text.trimEnd() + ` ${isPopulated ? rb(`n${n}_lobe`, 'RLL', 'RLL') : '[ ] RLL'}`;
            text = text.trimEnd() + ` ${isPopulated ? rb(`n${n}_lobe`, 'LUL', 'LUL') : '[ ] LUL'}`;
            text = text.trimEnd() + ` ${isPopulated ? rb(`n${n}_lobe`, 'LLL', 'LLL') : '[ ] LLL'}`;

            // Status
            text += `\n    The nodule is ${isPopulated ? rb(`n${n}_status`, 'unchanged', 'unchanged') : '[ ] unchanged'}`;
            text = text.trimEnd() + ` ${isPopulated ? rb(`n${n}_status`, 'enlarging', 'enlarging (>1.5 mm)') : '[ ] enlarging (>1.5 mm)'}`;
            text = text.trimEnd() + ` ${isPopulated ? rb(`n${n}_status`, 'newly found', 'newly found (â‰§4 mm)') : '[ ] newly found (â‰§4 mm)'}`;
            text = text.trimEnd() + ` ${isPopulated ? rb(`n${n}_status`, 'no prior', 'No prior chest CT comparison') : '[ ] No prior chest CT comparison'}\n`;

            return text;
        }

        function generateReportText(isSimple = false) {
            let report = "";
            const add = (text) => { report += text; };
            const addLine = (condition, lineGenerator) => {
                if (!isSimple || condition) add(lineGenerator());
            };
            const addLineCb = (id, text) => addLine(isChecked(id), () => cb(id, text));

            report += `LDCT Quality: ${rb('quality', 'Good', 'Good')}`;
            report = report.trimEnd() + ` ${rb('quality', 'Acceptable', 'Acceptable')}`;
            report = report.trimEnd() + ` ${rb('quality', 'Not Acceptable', 'Not Acceptable')}`;
            report += `CTDIvol: ${txt('ctdi')} mGy Total DLP: ${txt('dlp')} mGy*cm\n`;
            report += `In comparison with the prior CT, Date (Y/M/D) ${txt('prior_date')} ${cb('no_prior', 'No prior chest CT available')}`;

            report += "\nLung nodule findings related to cancer screening\n";
            report += "è©³ç´°è¦ç¯„è«‹åƒé–± Lung-RADS v2022\n\n";

            addLineCb('no_nodule', 'No lung nodule');
            addLineCb('benign_features', 'Nodule with benign features.');
            addLine(isChecked('nodule_lt6'), () => cb_se_im('nodule_lt6', 'Lung nodule(s) (<6mm)', 'lt6_se', 'lt6_im'));
            addLineCb('juxtapleural', 'Juxtapleural nodule.');

            // Logic for Nodule Block Output
            // Requirement 1: Full report must output 1,2,3 templates even if unchecked
            const isGte6Checked = isChecked('nodule_gte6');

            if (isSimple && !isGte6Checked) {
                // Simple report + unchecked: Output nothing for this section
            } else {
                // Either Full Report (always output) OR Simple Report (output if checked)
                if (isGte6Checked) {
                    report += "[+] Lung nodule(s) (â‰§6mm or enlarging>1.5mm or newâ‰§4mm): total number ";
                    report += `${rb('total_nodules', '1', '1')}`;
                    report = report.trimEnd() + ` ${rb('total_nodules', '2', '2')}`;
                    report = report.trimEnd() + ` ${rb('total_nodules', '3', '3')}`;
                    report = report.trimEnd() + ` ${rb('total_nodules', '>=4', 'â‰¥4')}`;
                    report += "  è«‹ä¾åºæè¿°æœ€æ‡·ç–‘ä¹‹è‚ºçµç¯€(è‡³å¤š 3 å€‹) (Describe the most suspicious 3 nodules in order)\n\n";
                } else if (!isSimple) {
                     // Full report, unchecked
                     report += "[ ] Lung nodule(s) (â‰§6mm or enlarging>1.5mm or newâ‰§4mm): total number [ ]1 [ ]2 [ ]3 [ ]â‰¥4, and described as followings:\n";
                }

                // Generate N1, N2, N3
                report += generateNoduleText(1, isSimple);
                report += generateNoduleText(2, isSimple);
                report += generateNoduleText(3, isSimple);

                // Else block
                const totalVal = getRadio('total_nodules');
                const showElse = (totalVal === '>=4');
                const elseLobesChecked = isChecked('else_rul') || isChecked('else_rml') || isChecked('else_rll') || isChecked('else_lul') || isChecked('else_lll');

                if (isSimple) {
                    // Only show if active and visible (>=4)
                    if (isGte6Checked && showElse) {
                        report += `  ${elseLobesChecked ? '[+]' : '[ ]'} Lung nodules else `;
                        report += `${cb_inline('else_rul', 'RUL')} `;
                        report += `${cb_inline('else_rml', 'RML')} `;
                        report += `${cb_inline('else_rll', 'RLL')} `;
                        report += `${cb_inline('else_lul', 'LUL')} `;
                        report += `${cb_inline('else_lll', 'LLL')} `;
                        report += `(SE:${txt('else_se')}, IM:${txt('else_im')})\n`;
                    }
                } else {
                    // Full report: Always show template
                    report += `  ${elseLobesChecked && showElse ? '[+]' : '[ ]'} Lung nodules else `;
                    report += `${showElse ? cb_inline('else_rul', 'RUL') : '[ ] RUL'} `;
                    report += `${showElse ? cb_inline('else_rml', 'RML') : '[ ] RML'} `;
                    report += `${showElse ? cb_inline('else_rll', 'RLL') : '[ ] RLL'} `;
                    report += `${showElse ? cb_inline('else_lul', 'LUL') : '[ ] LUL'} `;
                    report += `${showElse ? cb_inline('else_lll', 'LLL') : '[ ] LLL'} `;
                    report += `(SE:${showElse ? txt('else_se') : '_'}, IM:${showElse ? txt('else_im') : '_'})\n`;
                }
            }
            report += "\n";

            let airwayChecked = isChecked('airway_subsegmental') || isChecked('airway_proximal');
            if (!isSimple || airwayChecked) {
                report += `${airwayChecked ? '[+]' : '[ ]'} Airway nodule\n`;
                addLine(true, () => `  ${cb('airway_subsegmental', 'Subsegmental (Category 2)')}`);
                addLine(true, () => `  ${cb('airway_proximal', 'Segmental or more proximal')}`);
                addLine(true, () => `    ${cb('airway_secretions', 'Favors secretions (Category 2)')}`);
                addLine(true, () => `    ${cb('airway_baseline', 'At baseline (Category 4A)')}`);
                addLine(true, () => `    ${cb('airway_stable', 'Stable or growing (Category 4B)')}`);
                report += "\n";
            }

            let cystChecked = isChecked('cyst_3') || isChecked('cyst_4a') || isChecked('cyst_4b');
            if (!isSimple || cystChecked) {
                const getCystString = (cat_id, cat_name, se_id, im_id, isSimple) => {
                    if (isSimple && !isChecked(cat_id)) return "";
                    let line = `  ${cb(cat_id, `Category ${cat_name}. Lobe: (SE: ${txt(se_id)}, IM: ${txt(im_id)}) `)}`;
                    line = line.trimEnd();
                    line += ` ${cb_inline(cat_id + '_rul', 'RUL')}`;
                    line += ` ${cb_inline(cat_id + '_rml', 'RML')}`;
                    line += ` ${cb_inline(cat_id + '_rll', 'RLL')}`;
                    line += ` ${cb_inline(cat_id + '_lul', 'LUL')}`;
                    line += ` ${cb_inline(cat_id + '_lll', 'LLL')}\n`;
                    return line;
                };
                report += `${cystChecked ? '[+]' : '[ ]'} Atypical pulmonary cyst\n`;
                add(getCystString('cyst_3', '3', 'cyst_3_se', 'cyst_3_im', isSimple));
                add(getCystString('cyst_4a', '4A', 'cyst_4a_se', 'cyst_4a_im', isSimple));
                add(getCystString('cyst_4b', '4B', 'cyst_4b_se', 'cyst_4b_im', isSimple));
                report += "\n";
            }

            addLineCb('metastases', 'The pattern of lung nodules has a higher probability of metastases');

            let otherLungChecked = isChecked('other_emphysema') || isChecked('other_bronchiectasis') || isChecked('other_bronchitis') || isChecked('other_treeinbud') || isChecked('other_centrilobular') || isChecked('other_tb') || isChecked('other_ild') || isChecked('other_other_lung_check');
            if (!isSimple || otherLungChecked) {
                report += "\n----\nOther Lung Findings (é¸å¡«)\n";
                let line1 = "", line2 = "";
                if (!isSimple || isChecked('other_emphysema')) line1 += `${cb_inline('other_emphysema', 'Emphysema')} `;
                if (!isSimple || isChecked('other_bronchiectasis')) line1 += `${cb_inline('other_bronchiectasis', 'Bronchiectasis')} `;
                if (!isSimple || isChecked('other_bronchitis')) line1 += `${cb_inline('other_bronchitis', 'Bronchitis/bronchiolitis')} `;
                if (!isSimple || isChecked('other_treeinbud')) line1 += `${cb_inline('other_treeinbud', 'Tree-in-bud pattern')}`;

                if (!isSimple || isChecked('other_centrilobular')) line2 += `${cb_inline('other_centrilobular', 'Centrilobular nodules')} `;
                if (!isSimple || isChecked('other_tb')) line2 += `${cb_inline('other_tb', 'Old pulmonary TB')} `;
                if (!isSimple || isChecked('other_ild')) line2 += `${cb_inline('other_ild', 'Interstitial lung disease (ILD)')} `;
                if (!isSimple || isChecked('other_other_lung_check')) line2 += `${cb_inline('other_other_lung_check', `Other ${txt('other_other_lung_text')}`)}`;

                if (line1.trim() !== "") report += line1.trimEnd() + "\n";
                if (line2.trim() !== "") report += line2.trimEnd() + "\n";
            }

            let otherFindingsChecked = getValue('other_lymph') || getValue('other_coronary') || getValue('other_chest') || getValue('other_abnormal');
            if (!isSimple || otherFindingsChecked) {
                report += "\nOther Findings (é¸å¡«)\n";
                const addOtherFinding = (id, text) => {
                    const val = getValue(id);
                    if (isSimple && !val) return;
                    const mark = val ? '[+]' : '[ ]';
                    const content = val ? `: ${val}` : '';
                    report += `${mark} ${text}${content}\n`;
                }
                addOtherFinding('other_lymph', 'Enlarged lymph nodes, location');
                addOtherFinding('other_coronary', 'Coronary artery calcification');
                addOtherFinding('other_chest', 'Other significant abnormal chest findings');
                addOtherFinding('other_abnormal', 'Other significant abnormal abdominal or neck findings in this chest CT scan');
            }

            report += "\n----\nOverall recommendation\n";
            report += "Lung-RADS v2022 Category Descriptor\n";
            report += `  ${rb('category', '0', 'Category 0: Incomplete.')}`;
            report += `    ${cb('cat_0_prior', 'Prior chest CT examination being located for comparison.')}`;
            report += `    ${cb('cat_0_unevaluated', 'Part or all of lungs cannot be evaluated.')}`;
            report += `    ${cb('cat_0_inflammatory', 'Findings suggestive of an inflammatory or infectious process.')}`;
            report += `  ${rb('category', '1', 'Category 1: Negative.')}`;
            report += `  ${rb('category', '2', 'Category 2: Benign - Based on imaging features or indolent behavior.')}`;
            report += `  ${rb('category', '3', 'Category 3: Probably Benign - Based on imaging features or behavior.')}`;
            report += `  ${rb('category', '4A', 'Category 4A: Suspicious.')}`;
            report += `  ${rb('category', '4B', 'Category 4B: Very suspicious.')}`;
            report += `  ${rb('category', '4X', 'Category 4X: Category 3 or 4 nodules with additional features or imaging findings that increase suspicion for lung cancer.')}`;

            if (!isSimple || isChecked('modifier_s') || isChecked('refer_opd')) {
                report += "\n----\n(é¸å¡«)\n";
                addLineCb('modifier_s', 'Modifier S: May add to category 0-4 for clinically significant or potentially clinically significant findings unrelated to lung cancer.');
                addLineCb('refer_opd', 'è«‹è‡³é–€è¨ºå°±è¨º');
            }

            return report.replace(/\n\n\n/g, '\n\n');
        }

        function copyToClipboardAndShowModal(report, buttonId, title) {
            navigator.clipboard.writeText(report).then(() => {
                $('modal_output').textContent = report;
                $('modal_title').textContent = title + " (å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿)";
                openModal('report_modal');
                const btn = $(buttonId);
                const originalText = (buttonId === 'copy_button') ? 'è¤‡è£½å®Œæ•´å ±å‘Š' : 'è¤‡è£½ç°¡æ˜“å ±å‘Š';
                btn.innerHTML = "âœ“ å·²è¤‡è£½ï¼";
                btn.disabled = true;
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—: ', err);
                alert('è¤‡è£½å¤±æ•—ã€‚è«‹æª¢æŸ¥æ‚¨çš„ç€è¦½å™¨æ¬Šé™è¨­å®šã€‚');
            });
        }
        function generateAndCopyFull() {
            const report = generateReportText(false);
            copyToClipboardAndShowModal(report, 'copy_button', 'å®Œæ•´å ±å‘Šå…§å®¹');
        }
        function generateAndCopySimple() {
            const report = generateReportText(true);
            copyToClipboardAndShowModal(report, 'copy_simple_button', 'ç°¡æ˜“å ±å‘Šå…§å®¹');
        }

        // --- D. è‡ªå‹•åˆ¤å®š Category é‚è¼¯ (Lung-RADS 2022) ---
        function autoCalculateCategory() {
            const CAT_4B = 6; const CAT_4A = 5; const CAT_3 = 4; const CAT_2 = 3; const CAT_1 = 2; const CAT_0 = 10;
            let currentScore = 0;
            const setScore = (score) => { if (score > currentScore) currentScore = score; };

            if (isChecked('cat_0_prior') || isChecked('cat_0_unevaluated') || isChecked('cat_0_inflammatory')) {
                setScore(CAT_0);
            }
            if (currentScore === CAT_0) { checkCategoryRadio("0"); return; }

            if (isChecked('airway_stable')) setScore(CAT_4B);
            if (isChecked('cyst_4b')) setScore(CAT_4B);

            for (let i = 1; i <= 3; i++) {
                if (!isChecked('nodule_gte6') || !isChecked(`n${i}_enable`)) continue;
                let size = parseFloat(getValue(`n${i}_size`)) || 0;
                let density = getRadio(`n${i}_density`);
                let solidPart = parseFloat(getValue(`n${i}_solid_part`)) || 0;
                let status = getRadio(`n${i}_status`);

                if (density === 'solid') {
                    if (size >= 15) setScore(CAT_4B);
                    if ((status === 'newly found' || status === 'enlarging') && size >= 8) setScore(CAT_4B);
                } else if (density === 'part-solid') {
                    if (solidPart >= 8) setScore(CAT_4B);
                    if ((status === 'newly found' || status === 'enlarging') && solidPart >= 4) setScore(CAT_4B);
                }
            }

            if (currentScore < CAT_4B) {
                if (isChecked('airway_baseline')) setScore(CAT_4A);
                if (isChecked('cyst_4a')) setScore(CAT_4A);
                for (let i = 1; i <= 3; i++) {
                    if (!isChecked('nodule_gte6') || !isChecked(`n${i}_enable`)) continue;
                    let size = parseFloat(getValue(`n${i}_size`)) || 0;
                    let density = getRadio(`n${i}_density`);
                    let solidPart = parseFloat(getValue(`n${i}_solid_part`)) || 0;
                    let status = getRadio(`n${i}_status`);
                    if (density === 'solid') {
                        if (size >= 8 && size < 15) setScore(CAT_4A);
                        if (status === 'enlarging' && size < 8) setScore(CAT_4A);
                        if (status === 'newly found' && size >= 6 && size < 8) setScore(CAT_4A);
                    } else if (density === 'part-solid') {
                        if (size >= 6 && solidPart >= 6 && solidPart < 8) setScore(CAT_4A);
                        if ((status === 'newly found' || status === 'enlarging') && solidPart < 4) setScore(CAT_4A);
                    }
                }
            }

            if (currentScore < CAT_4A) {
                if (isChecked('cyst_3')) setScore(CAT_3);
                for (let i = 1; i <= 3; i++) {
                    if (!isChecked('nodule_gte6') || !isChecked(`n${i}_enable`)) continue;
                    let size = parseFloat(getValue(`n${i}_size`)) || 0;
                    let density = getRadio(`n${i}_density`);
                    let solidPart = parseFloat(getValue(`n${i}_solid_part`)) || 0;
                    let status = getRadio(`n${i}_status`);
                    if (density === 'solid') {
                        if (size >= 6 && size < 8) setScore(CAT_3);
                        if (status === 'newly found' && size >= 4 && size < 6) setScore(CAT_3);
                    } else if (density === 'part-solid') {
                        if (size >= 6 && solidPart < 6) setScore(CAT_3);
                        if (status === 'newly found' && size < 6) setScore(CAT_3);
                    } else if (density === 'non-solid') {
                        if (size >= 30 && (status === 'no prior' || status === 'newly found')) {
                            setScore(CAT_3);
                        }
                    }
                }
            }

            if (currentScore < CAT_3) {
                if (isChecked('nodule_lt6')) setScore(CAT_2);
                if (isChecked('juxtapleural')) setScore(CAT_2);
                if (isChecked('airway_subsegmental') || isChecked('airway_secretions')) setScore(CAT_2);
                for (let i = 1; i <= 3; i++) {
                    if (!isChecked('nodule_gte6') || !isChecked(`n${i}_enable`)) continue;
                    let size = parseFloat(getValue(`n${i}_size`)) || 0;
                    let density = getRadio(`n${i}_density`);
                    let status = getRadio(`n${i}_status`);
                    if (density === 'solid') {
                        if (size < 6) setScore(CAT_2);
                        if (status === 'newly found' && size < 4) setScore(CAT_2);
                    } else if (density === 'part-solid') {
                        if (size < 6) setScore(CAT_2);
                    } else if (density === 'non-solid') { setScore(CAT_2); }
                }
            }

            if (currentScore < CAT_2) {
                if (isChecked('no_nodule') || isChecked('benign_features')) setScore(CAT_1);
            }

            if (currentScore === CAT_4B) checkCategoryRadio("4B");
            else if (currentScore === CAT_4A) checkCategoryRadio("4A");
            else if (currentScore === CAT_3) checkCategoryRadio("3");
            else if (currentScore === CAT_2) checkCategoryRadio("2");
            else if (currentScore === CAT_1) checkCategoryRadio("1");
        }

        function checkCategoryRadio(val) {
            const radio = document.querySelector(`input[name="category"][value="${val}"]`);
            if (radio && !radio.checked) radio.checked = true;
        }

        document.querySelector('main').addEventListener('change', autoCalculateCategory);
        document.querySelector('main').addEventListener('input', autoCalculateCategory);
    </script>
</body>
</html>