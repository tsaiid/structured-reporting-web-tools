<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lung-RADS v2022 å ±å‘Šç”¢ç”Ÿå™¨ (v13.9)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <style>
        /* --- åŸºç¤è®Šæ•¸èª¿æ•´ --- */
        :root {
            --nav-height: 80px;
            --nav-bg-light: rgba(255, 255, 255, 0.95);
            --nav-bg-dark: rgba(19, 23, 31, 0.95);
            --border-radius: 8px;
        }

        body {
            padding-top: calc(var(--nav-height) + 20px);
            padding-bottom: 100px;
        }

        /* --- Sticky Navbar --- */
        .sticky-nav {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--nav-height); z-index: 900;
            background-color: var(--nav-bg-light); border-bottom: 1px solid var(--pico-muted-border-color);
            backdrop-filter: blur(10px); box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: background-color 0.3s; display: flex; align-items: center;
        }
        [data-theme="dark"] .sticky-nav { background-color: var(--nav-bg-dark); }

        .nav-content {
            width: 100%; max-width: 1152px; margin: 0 auto; padding: 0 1rem;
            display: flex; justify-content: space-between; align-items: center;
        }

        .nav-title-group h1 { font-size: 1.75rem; margin: 0; line-height: 1.1; color: var(--pico-h1-color); font-weight: 800; }
        .nav-title-group p { font-size: 0.85rem; margin: 0; color: var(--pico-muted-color); display: block; margin-top: 2px; }
        .nav-controls { display: flex; align-items: center; gap: 1rem; height: 100%; }

        /* --- Theme Capsule Switch --- */
        .theme-capsule {
            position: relative; display: inline-flex !important; width: 64px !important; height: 34px !important;
            align-items: center; justify-content: center; border: 2px solid var(--pico-muted-border-color);
            border-radius: 50px; cursor: pointer; background-color: transparent; transition: all 0.3s ease;
            margin-bottom: 0; flex-shrink: 0; box-sizing: border-box;
        }
        .theme-capsule:hover { border-color: var(--pico-primary); background-color: var(--pico-background-color); }
        .theme-capsule input { appearance: none; -webkit-appearance: none; position: absolute; opacity: 0; width: 0; height: 0; margin: 0; pointer-events: none; }

        .capsule-content { position: relative; width: 100%; height: 100%; overflow: hidden; border-radius: 34px; }
        .capsule-icon {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.3s;
        }
        .capsule-icon svg { width: 20px; height: 20px; display: block; }

        .icon-sun { opacity: 1; transform: translateY(0); color: #f59e0b; }
        .icon-moon { opacity: 0; transform: translateY(30px) rotate(-90deg); color: #fbbf24; }

        .theme-capsule input:checked ~ .capsule-content .icon-sun { opacity: 0; transform: translateY(-30px) rotate(90deg); }
        .theme-capsule input:checked ~ .capsule-content .icon-moon { opacity: 1; transform: translateY(0) rotate(0deg); }

        [data-theme="dark"] .theme-capsule { border-color: #546e7a; background-color: rgba(255, 255, 255, 0.05); }
        [data-theme="dark"] .theme-capsule:hover { border-color: var(--pico-primary); }

        .btn-about {
            background: transparent; border: 2px solid var(--pico-muted-border-color); color: var(--pico-muted-color);
            width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            padding: 0; font-weight: 800; font-size: 1.1rem; transition: all 0.2s; margin-bottom: 0; flex-shrink: 0;
        }
        .btn-about:hover { border-color: var(--pico-primary); color: var(--pico-primary); background-color: var(--pico-card-background-color); }

        /* --- [é—œéµä¿®æ­£] Dark Mode æ¨£å¼éš”é›¢ --- */
        /* ç›®æ¨™ï¼šåªèª¿æ•´æ–‡å­—è¼¸å…¥æ¡†çš„é¡è‰²ï¼Œçµ•å°ä¸ç¢° Radio/Checkbox */

        /* å®šç¾©é¸æ“‡å™¨ï¼šæ’é™¤ radio, checkbox, button, submit */
        [data-theme="dark"] input:not([type="radio"]):not([type="checkbox"]):not([type="submit"]):not([type="button"]),
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            background-color: #1e252e !important;
            border-color: #4a5a6a !important;
            color: #ffffff !important;
        }

        /* å®šç¾© Focus ç‹€æ…‹ï¼šåŒæ¨£æ’é™¤ radio, checkbox */
        [data-theme="dark"] input:not([type="radio"]):not([type="checkbox"]):focus,
        [data-theme="dark"] select:focus {
            border-color: var(--pico-primary) !important;
            background-color: #26303b !important;
            box-shadow: 0 0 0 2px rgba(2, 117, 216, 0.2); /* æ¨¡ä»¿ Pico åŸç”Ÿ Focus */
        }

        /* é‡å° Radio/Checkbox æˆ‘å€‘ä»€éº¼éƒ½ä¸åšï¼Œè®“ Pico åŸç”Ÿæ¨£å¼æ¥ç®¡ï¼Œé€™æ¨£æœ€ç©©å®š */

        /* --- [é—œéµä¿®æ­£] å°é½Šç³»çµ± (Alignment) --- */
        .inline-label-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center; /* å®¹å™¨å…§å‚ç›´ç½®ä¸­ */
            gap: 1rem;
            margin-bottom: var(--pico-spacing);
        }

        .inline-label-group > span {
            display: flex;
            align-items: center; /* span å…§å‚ç›´ç½®ä¸­ */
            height: 100%;
        }

        /* æ¨™ç±¤æ–‡å­—é–“è·èˆ‡é«˜åº¦ä¿®æ­£ */
        .label-text,
        .inline-label-group > span > span:first-child {
            margin-right: 0.75rem;
            line-height: 1; /* é¿å…æ–‡å­—è¡Œé«˜æ’é–‹é«˜åº¦å°è‡´ä¸å°é½Š */
            padding-top: 1px; /* å¾®èª¿è¦–è¦ºé‡å¿ƒ */
        }

        /* è®“åŒ…å« Input çš„ Label (Good, Acceptable) è®Šæˆ Flex å®¹å™¨ */
        .inline-label-group label,
        .horizontal-radios label,
        .horizontal-checkboxes label {
            display: inline-flex !important;
            align-items: center !important; /* ç¢ºä¿ Input èˆ‡æ–‡å­—ä¸­ç·šå°é½Š */
            margin-bottom: 0 !important;
            cursor: pointer;
        }

        /* ç§»é™¤ Input è‡ªèº«çš„å¤šé¤˜ Marginï¼Œå®Œå…¨äº¤çµ¦ Flex æ§åˆ¶ */
        input[type="checkbox"], input[type="radio"] {
            margin: 0 0.5rem 0 0 !important;
            transform: none !important; /* ç§»é™¤ä»»ä½•ä½ç§» */
        }

        /* é€šç”¨ Input è¨­å®š */
        input.form-input, input[type="number"], input[type="text"], select {
            font-size: 0.9em; padding: 0.2rem 0.4rem; height: auto; margin: 0 0.25em; width: auto;
            display: inline-block;
        }

        .unit-label { color: var(--pico-muted-color); margin-left: 0.5rem; font-size: 0.9em; display: inline-flex; align-items: center;}

        /* Error Styles */
        .input-error { border: 2px solid #e53935 !important; box-shadow: 0 0 5px rgba(229, 57, 53, 0.5); transition: all 0.3s ease; }
        [data-theme="dark"] .input-error { border-color: #ff5252 !important; box-shadow: 0 0 8px rgba(255, 82, 82, 0.8) !important; background-color: rgba(255, 82, 82, 0.1) !important; }

        /* General Layout */
        .sticky-footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--pico-background-color); border-top: 1px solid var(--pico-primary); box-shadow: 0 -1px 5px rgba(0, 0, 0, 0.15); padding: 1rem; z-index: 100; transition: opacity 0.3s, transform 0.3s; opacity: 0; transform: translateY(100%); visibility: hidden; }
        .sticky-footer.visible { opacity: 1; transform: translateY(0); visibility: visible; }
        .footer-container { display: flex; justify-content: space-between; align-items: center; max-width: 1152px; margin: 0 auto; padding: 0 1rem; gap: 1rem; }
        .footer-container button { margin-bottom: 0; }
        .nested-section { padding-left: 1.5rem; border-left: 3px solid var(--pico-primary); margin-top: 0.5rem; }
        .hidden { display: none !important; }
        .horizontal-checkboxes { display: flex; flex-wrap: wrap; align-items: center; gap: 1.5rem; margin-bottom: 1rem; }
        .se-im-row { display: flex; align-items: center; flex-wrap: wrap; gap: 2rem; }
        .se-im-row label { display: inline-flex; align-items: center; margin-bottom: 0; }
        article.nodule-block { margin-bottom: 2rem; padding: 1.5rem; border: 1px solid var(--pico-muted-border-color); box-shadow: 0 4px 8px rgba(0,0,0,0.08); background-color: var(--pico-card-background-color); border-radius: var(--border-radius); position: relative; }
        .nodule-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 2px solid var(--pico-muted-border-color); padding-bottom: 0.5rem; }
        .nodule-title { font-weight: bold; font-size: 1.2em; color: var(--pico-primary); }
        .btn-delete { background-color: transparent; border: 1px solid var(--pico-del-color); color: var(--pico-del-color); padding: 0.3rem 0.8rem; font-size: 0.8em; cursor: pointer; margin-bottom: 0; transition: all 0.2s; }
        .btn-delete:hover { background-color: var(--pico-del-color); color: white; border-color: var(--pico-del-color); }
        .nodule-split-row { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start; margin-bottom: 1rem; border-bottom: 1px solid var(--pico-muted-border-color); padding-bottom: 1rem; }
        .nodule-input-label { font-weight: bold; font-size: 1rem; color: var(--pico-h1-color); display: block; margin-bottom: 0.5rem; }
        .density-inline-group { display: flex; flex-wrap: nowrap; align-items: center; gap: 1rem; }
        .density-inline-group label { display: inline-flex; align-items: center; margin-bottom: 0; white-space: nowrap; font-size: 0.9em; }
        .size-input-row { display: flex; flex-wrap: nowrap; align-items: center; white-space: nowrap; margin-bottom: 0.5rem; }
        .nodule-row-full { width: 100%; margin-bottom: 1rem; }
        .lobe-inline-wrapper { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; }
        .lobe-label { white-space: nowrap; margin-right: 1rem; font-weight: bold; font-size: 1rem; display: inline-flex; align-items: center; }
        .horizontal-radios { display: flex; flex-wrap: wrap; gap: 1rem; }
        .solid-part-container { margin-top: 0.2rem; margin-left: 0; padding-left: 2rem; }

        #modal_output { white-space: pre-wrap; word-wrap: break-word; background-color: var(--pico-muted-background-color); padding: 1rem; border-radius: var(--border-radius); font-family: var(--pico-font-family-monospace); }
        dialog article { width: 90vw; max-width: 1000px; }
        #delete_modal article { max-width: 400px; text-align: center; }
        #about_modal article { max-width: 600px; text-align: left; }
        .modal-actions { display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem; }
        .lobe-checkbox-container { display: inline-flex; flex-wrap: wrap; gap: 0.5rem; vertical-align: middle; margin-left: 1rem;}
        .lobe-checkbox-container span label { margin-bottom: 0; font-size: 0.9em; display: inline-flex; align-items: center;}

        fieldset { margin-bottom: var(--pico-spacing); border: none; padding: 0; }
        /* Fieldset å…§çš„ label ä¹Ÿè¦ Flex å°é½Š */
        fieldset label { display: flex; align-items: center; margin-bottom: 0.5rem; cursor: pointer; }
        legend { font-weight: bold; margin-bottom: 0.5rem; }

        @media (max-width: 576px) {
            .nav-title-group p { display: none; }
            .nav-title-group h1 { font-size: 1.2rem; }
            .nav-content { padding: 0 0.5rem; }
            .theme-capsule { width: 48px; height: 30px; }
            .btn-about { width: 30px; height: 30px; font-size: 1rem; }
            .capsule-icon { font-size: 1rem; }
        }
    </style>
</head>
<body>

    <nav class="sticky-nav">
        <div class="nav-content">
            <div class="nav-title-group">
                <h1>Lung-RADS v2022 å ±å‘Šç”¢ç”Ÿå™¨</h1>
                <p>å¡«å¯«ä»¥ä¸‹æ¬„ä½ï¼Œé»æ“Šã€Œè¤‡è£½å ±å‘Šã€æŒ‰éˆ•å³å¯ç”¢ç”Ÿç´”æ–‡å­—å ±å‘Šã€‚</p>
            </div>

            <div class="nav-controls">
                <button class="btn-about" onclick="openModal('about_modal')" title="About this project" aria-label="About">
                    ?
                </button>

                <label class="theme-capsule" title="Toggle Dark/Light Mode">
                    <input type="checkbox" id="theme_toggle" onchange="toggleTheme()">
                    <div class="capsule-content">
                        <div class="capsule-icon icon-sun">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                            </svg>
                        </div>
                        <div class="capsule-icon icon-moon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                              <path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.7-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 01.818.162z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                </label>
            </div>
        </div>
    </nav>

    <main class="container">
        <article>
            <section>
                <div class="inline-label-group">
                    <span class="label-text">LDCT Quality:</span>
                    <span><label><input type="radio" name="quality" value="Good" checked> Good</label></span>
                    <span><label><input type="radio" name="quality" value="Acceptable"> Acceptable</label></span>
                    <span><label><input type="radio" name="quality" value="Not Acceptable"> Not Acceptable</label></span>
                </div>

                <div class="inline-label-group">
                    <span><span class="label-text">CTDIvol:</span><input type="text" class="form-input num-only" id="ctdi" placeholder="" style="width: 80px;"><span class="unit-label">mGy</span></span>
                    <span><span class="label-text">Total DLP:</span><input type="text" class="form-input num-only" id="dlp" placeholder="" style="width: 100px;"><span class="unit-label">mGy*cm</span></span>
                </div>

                <div class="inline-label-group">
                    <span><span class="label-text">Prior CT Date (Y/M/D):</span><input type="text" class="form-input" id="prior_date" placeholder="YYYY/MM/DD" style="width: 160px;" oninput="handlePriorDateInput()"></span>
                    <span><label><input type="checkbox" id="no_prior" onchange="togglePriorDate(this.checked)"> No prior chest CT available</label></span>
                </div>
            </section>

            <hr>

            <section>
                <h3>Lung nodule findings related to cancer screening</h3>
                <p><small>è©³ç´°è¦ç¯„è«‹åƒé–± Lung-RADS v2022</small></p>
                <fieldset>
                    <label><input type="checkbox" id="no_nodule"> No lung nodule</label>
                    <label><input type="checkbox" id="benign_features"> Nodule with benign features.</label>
                    <label><input type="checkbox" id="nodule_lt6"> Lung nodule(s) (&lt;6mm) (é¸å¡« SE: <input type="text" class="form-input" id="lt6_se" style="width: 60px;">, IM: <input type="text" class="form-input" id="lt6_im" style="width: 350px; max-width: 80vw;">)</label>
                    <label><input type="checkbox" id="juxtapleural"> Juxtapleural nodule.</label>
                    <label>
                        <input type="checkbox" id="nodule_gte6" onchange="handleNoduleGte6Change(this.checked)">
                        Lung nodule(s) (â‰§6mm or enlarging&gt;1.5mm or newâ‰§4mm)
                    </label>
                </fieldset>
                <div id="nodule_details" class="nested-section hidden">
                    <fieldset>
                        <legend>Total number</legend>
                        <div class="horizontal-radios">
                            <label><input type="radio" name="total_nodules" value="1" onchange="updateNoduleCount()"> 1</label>
                            <label><input type="radio" name="total_nodules" value="2" onchange="updateNoduleCount()"> 2</label>
                            <label><input type="radio" name="total_nodules" value="3" onchange="updateNoduleCount()"> 3</label>
                            <label><input type="radio" name="total_nodules" value=">=4" onchange="updateNoduleCount()"> â‰¥4</label>
                        </div>
                    </fieldset>
                    <p>è«‹ä¾åºæè¿°æœ€æ‡·ç–‘ä¹‹è‚ºçµç¯€(è‡³å¤š 3 å€‹)</p>

                    <article id="block_n1" class="nodule-block hidden">
                        <div class="nodule-header">
                            <span class="nodule-title">Lung nodule 1</span>
                            <button class="btn-delete" onclick="promptDelete(1)" title="åˆªé™¤æ­¤çµç¯€ä¸¦å¾€ä¸Šéè£œ">ğŸ—‘ åˆªé™¤</button>
                        </div>
                        <input type="checkbox" id="n1_enable" class="hidden">

                        <div class="nodule-split-row">
                            <div class="col-density" id="n1_density_group">
                                <legend class="nodule-input-label">Density:</legend>
                                <div class="density-inline-group">
                                    <label><input type="radio" name="n1_density" value="non-solid" onchange="toggleSolidPart('n1_solid_container', this.value)"> non-solid</label>
                                    <label><input type="radio" name="n1_density" value="part-solid" onchange="toggleSolidPart('n1_solid_container', this.value)"> part-solid</label>
                                    <label><input type="radio" name="n1_density" value="solid" onchange="toggleSolidPart('n1_solid_container', this.value)"> solid</label>
                                </div>
                            </div>
                            <div class="col-size">
                                <div class="size-input-row">
                                    <label class="nodule-input-label" style="margin-bottom:0;">Entire Nodule:</label>
                                    <input type="text" class="form-input num-only" id="n1_size" style="width: 80px;"> <span class="unit-label">mm</span>
                                </div>
                                <div id="n1_solid_container" class="size-input-row hidden solid-part-container">
                                    <label class="nodule-input-label" style="margin-bottom:0; font-size: 0.9em;">Solid Part:</label>
                                    <input type="text" class="form-input num-only" id="n1_solid_part" style="width: 80px;"> <span class="unit-label">mm</span>
                                </div>
                            </div>
                        </div>

                        <div class="nodule-row-full">
                            <div class="lobe-inline-wrapper">
                                <div class="lobe-label">Lobe (SE: <input type="text" class="form-input" id="n1_se" style="width: 50px;">, IM: <input type="text" class="form-input" id="n1_im" style="width: 50px;">)</div>
                                <div class="horizontal-radios" id="n1_lobe_group">
                                    <label><input type="radio" name="n1_lobe" value="RUL"> RUL</label>
                                    <label><input type="radio" name="n1_lobe" value="RML"> RML</label>
                                    <label><input type="radio" name="n1_lobe" value="RLL"> RLL</label>
                                    <label><input type="radio" name="n1_lobe" value="LUL"> LUL</label>
                                    <label><input type="radio" name="n1_lobe" value="LLL"> LLL</label>
                                </div>
                            </div>
                        </div>

                        <div class="nodule-row-full" id="n1_status_group">
                            <legend class="nodule-input-label">Status</legend>
                            <div class="horizontal-radios">
                                <label><input type="radio" name="n1_status" value="unchanged"> unchanged</label>
                                <label><input type="radio" name="n1_status" value="enlarging"> enlarging (&gt;1.5 mm)</label>
                                <label><input type="radio" name="n1_status" value="newly found"> newly found (â‰§4 mm)</label>
                                <label><input type="radio" name="n1_status" value="no prior"> No prior chest CT comparison</label>
                            </div>
                        </div>
                    </article>

                    <article id="block_n2" class="nodule-block hidden">
                        <div class="nodule-header">
                            <span class="nodule-title">Lung nodule 2</span>
                            <button class="btn-delete" onclick="promptDelete(2)" title="åˆªé™¤æ­¤çµç¯€ä¸¦å¾€ä¸Šéè£œ">ğŸ—‘ åˆªé™¤</button>
                        </div>
                        <input type="checkbox" id="n2_enable" class="hidden">
                        <div class="nodule-split-row">
                            <div class="col-density" id="n2_density_group">
                                <legend class="nodule-input-label">Density:</legend>
                                <div class="density-inline-group">
                                    <label><input type="radio" name="n2_density" value="non-solid" onchange="toggleSolidPart('n2_solid_container', this.value)"> non-solid</label>
                                    <label><input type="radio" name="n2_density" value="part-solid" onchange="toggleSolidPart('n2_solid_container', this.value)"> part-solid</label>
                                    <label><input type="radio" name="n2_density" value="solid" onchange="toggleSolidPart('n2_solid_container', this.value)"> solid</label>
                                </div>
                            </div>
                            <div class="col-size">
                                <div class="size-input-row">
                                    <label class="nodule-input-label" style="margin-bottom:0;">Entire Nodule:</label>
                                    <input type="text" class="form-input num-only" id="n2_size" style="width: 80px;"> <span class="unit-label">mm</span>
                                </div>
                                <div id="n2_solid_container" class="size-input-row hidden solid-part-container">
                                    <label class="nodule-input-label" style="margin-bottom:0; font-size: 0.9em;">Solid Part:</label>
                                    <input type="text" class="form-input num-only" id="n2_solid_part" style="width: 80px;"> <span class="unit-label">mm</span>
                                </div>
                            </div>
                        </div>
                        <div class="nodule-row-full">
                            <div class="lobe-inline-wrapper">
                                <div class="lobe-label">Lobe (SE: <input type="text" class="form-input" id="n2_se" style="width: 50px;">, IM: <input type="text" class="form-input" id="n2_im" style="width: 50px;">)</div>
                                <div class="horizontal-radios" id="n2_lobe_group">
                                    <label><input type="radio" name="n2_lobe" value="RUL"> RUL</label>
                                    <label><input type="radio" name="n2_lobe" value="RML"> RML</label>
                                    <label><input type="radio" name="n2_lobe" value="RLL"> RLL</label>
                                    <label><input type="radio" name="n2_lobe" value="LUL"> LUL</label>
                                    <label><input type="radio" name="n2_lobe" value="LLL"> LLL</label>
                                </div>
                            </div>
                        </div>
                        <div class="nodule-row-full" id="n2_status_group">
                            <legend class="nodule-input-label">Status</legend>
                            <div class="horizontal-radios">
                                <label><input type="radio" name="n2_status" value="unchanged"> unchanged</label>
                                <label><input type="radio" name="n2_status" value="enlarging"> enlarging</label>
                                <label><input type="radio" name="n2_status" value="newly found"> newly found</label>
                                <label><input type="radio" name="n2_status" value="no prior"> No prior CT</label>
                            </div>
                        </div>
                    </article>

                    <article id="block_n3" class="nodule-block hidden">
                        <div class="nodule-header">
                            <span class="nodule-title">Lung nodule 3</span>
                            <button class="btn-delete" onclick="promptDelete(3)" title="åˆªé™¤æ­¤çµç¯€ä¸¦å¾€ä¸Šéè£œ">ğŸ—‘ åˆªé™¤</button>
                        </div>
                        <input type="checkbox" id="n3_enable" class="hidden">
                        <div class="nodule-split-row">
                            <div class="col-density" id="n3_density_group">
                                <legend class="nodule-input-label">Density:</legend>
                                <div class="density-inline-group">
                                    <label><input type="radio" name="n3_density" value="non-solid" onchange="toggleSolidPart('n3_solid_container', this.value)"> non-solid</label>
                                    <label><input type="radio" name="n3_density" value="part-solid" onchange="toggleSolidPart('n3_solid_container', this.value)"> part-solid</label>
                                    <label><input type="radio" name="n3_density" value="solid" onchange="toggleSolidPart('n3_solid_container', this.value)"> solid</label>
                                </div>
                            </div>
                            <div class="col-size">
                                <div class="size-input-row">
                                    <label class="nodule-input-label" style="margin-bottom:0;">Entire Nodule:</label>
                                    <input type="text" class="form-input num-only" id="n3_size" style="width: 80px;"> <span class="unit-label">mm</span>
                                </div>
                                <div id="n3_solid_container" class="size-input-row hidden solid-part-container">
                                    <label class="nodule-input-label" style="margin-bottom:0; font-size: 0.9em;">Solid Part:</label>
                                    <input type="text" class="form-input num-only" id="n3_solid_part" style="width: 80px;"> <span class="unit-label">mm</span>
                                </div>
                            </div>
                        </div>
                        <div class="nodule-row-full">
                            <div class="lobe-inline-wrapper">
                                <div class="lobe-label">Lobe (SE: <input type="text" class="form-input" id="n3_se" style="width: 50px;">, IM: <input type="text" class="form-input" id="n3_im" style="width: 50px;">)</div>
                                <div class="horizontal-radios" id="n3_lobe_group">
                                    <label><input type="radio" name="n3_lobe" value="RUL"> RUL</label>
                                    <label><input type="radio" name="n3_lobe" value="RML"> RML</label>
                                    <label><input type="radio" name="n3_lobe" value="RLL"> RLL</label>
                                    <label><input type="radio" name="n3_lobe" value="LUL"> LUL</label>
                                    <label><input type="radio" name="n3_lobe" value="LLL"> LLL</label>
                                </div>
                            </div>
                        </div>
                        <div class="nodule-row-full" id="n3_status_group">
                            <legend class="nodule-input-label">Status</legend>
                            <div class="horizontal-radios">
                                <label><input type="radio" name="n3_status" value="unchanged"> unchanged</label>
                                <label><input type="radio" name="n3_status" value="enlarging"> enlarging</label>
                                <label><input type="radio" name="n3_status" value="newly found"> newly found</label>
                                <label><input type="radio" name="n3_status" value="no prior"> No prior CT</label>
                            </div>
                        </div>
                    </article>

                    <article id="block_else" class="nodule-block hidden">
                        <label class="nodule-title">Lung nodules else</label>
                        <hr>
                        <div class="horizontal-checkboxes">
                            <label><input type="checkbox" id="else_rul"> RUL</label>
                            <label><input type="checkbox" id="else_rml"> RML</label>
                            <label><input type="checkbox" id="else_rll"> RLL</label>
                            <label><input type="checkbox" id="else_lul"> LUL</label>
                            <label><input type="checkbox" id="else_lll"> LLL</label>
                        </div>

                        <div class="se-im-row">
                            <label>SE: <input type="text" class="form-input" id="else_se" style="width: 150px;"></label>
                            <label>IM: <input type="text" class="form-input" id="else_im" style="width: 250px;"></label>
                        </div>
                    </article>
                </div>
            </section>

            <section>
                <fieldset>
                    <legend>Airway nodule</legend>
                    <label><input type="checkbox" id="airway_subsegmental"> Subsegmental (Category 2)</label>
                    <label>
                        <input type="checkbox" id="airway_proximal" onchange="clearAirwayChildren(this.checked)">
                        Segmental or more proximal
                    </label>
                    <div id="airway_proximal_details" class="nested-section">
                        <label><input type="checkbox" id="airway_secretions" onchange="updateAirwayParent()"> Favors secretions (Category 2)</label>
                        <label><input type="checkbox" id="airway_baseline" onchange="updateAirwayParent()"> At baseline (Category 4A)</label>
                        <label><input type="checkbox" id="airway_stable" onchange="updateAirwayParent()"> Stable or growing (Category 4B)</label>
                    </div>
                </fieldset>
            </section>

            <section>
                <fieldset>
                    <legend>Atypical pulmonary cyst</legend>
                    <label>
                        <input type="checkbox" id="cyst_3"> Category 3. Lobe: (SE: <input type="text" class="form-input" id="cyst_3_se" style="width: 50px;">, IM: <input type="text" class="form-input" id="cyst_3_im" style="width: 50px;">)
                        <span class="lobe-checkbox-container">
                            <span><label><input type="checkbox" id="cyst_3_rul"> RUL</label></span>
                            <span><label><input type="checkbox" id="cyst_3_rml"> RML</label></span>
                            <span><label><input type="checkbox" id="cyst_3_rll"> RLL</label></span>
                            <span><label><input type="checkbox" id="cyst_3_lul"> LUL</label></span>
                            <span><label><input type="checkbox" id="cyst_3_lll"> LLL</label></span>
                        </span>
                    </label>
                    <label>
                        <input type="checkbox" id="cyst_4a"> Category 4A. Lobe: (SE: <input type="text" class="form-input" id="cyst_4a_se" style="width: 50px;">, IM: <input type="text" class="form-input" id="cyst_4a_im" style="width: 50px;">)
                        <span class="lobe-checkbox-container">
                            <span><label><input type="checkbox" id="cyst_4a_rul"> RUL</label></span>
                            <span><label><input type="checkbox" id="cyst_4a_rml"> RML</label></span>
                            <span><label><input type="checkbox" id="cyst_4a_rll"> RLL</label></span>
                            <span><label><input type="checkbox" id="cyst_4a_lul"> LUL</label></span>
                            <span><label><input type="checkbox" id="cyst_4a_lll"> LLL</label></span>
                        </span>
                    </label>
                    <label>
                        <input type="checkbox" id="cyst_4b"> Category 4B. Lobe: (SE: <input type="text" class="form-input" id="cyst_4b_se" style="width: 50px;">, IM: <input type="text" class="form-input" id="cyst_4b_im" style="width: 50px;">)
                        <span class="lobe-checkbox-container">
                            <span><label><input type="checkbox" id="cyst_4b_rul"> RUL</label></span>
                            <span><label><input type="checkbox" id="cyst_4b_rml"> RML</label></span>
                            <span><label><input type="checkbox" id="cyst_4b_rll"> RLL</label></span>
                            <span><label><input type="checkbox" id="cyst_4b_lul"> LUL</label></span>
                            <span><label><input type="checkbox" id="cyst_4b_lll"> LLL</label></span>
                        </span>
                    </label>
                </fieldset>
            </section>

            <label><input type="checkbox" id="metastases"> The pattern of lung nodules has a higher probability of metastases</label>
            <hr>

            <section>
                <h3>Other Lung Findings (é¸å¡«)</h3>
                <fieldset>
                    <label><input type="checkbox" id="other_emphysema"> Emphysema</label>
                    <label><input type="checkbox" id="other_bronchiectasis"> Bronchiectasis</label>
                    <label><input type="checkbox" id="other_bronchitis"> Bronchitis/bronchiolitis</label>
                    <label><input type="checkbox" id="other_treeinbud"> Tree-in-bud pattern</label>
                    <label><input type="checkbox" id="other_centrilobular"> Centrilobular nodules</label>
                    <label><input type="checkbox" id="other_tb"> Old pulmonary TB</label>
                    <label><input type="checkbox" id="other_ild"> Interstitial lung disease (ILD)</label>
                    <label><input type="checkbox" id="other_other_lung_check"> Other <input type="text" class="form-input" id="other_other_lung_text" placeholder="..." style="width: 200px;"></label>
                </fieldset>
            </section>
            <section class="inline-inputs">
                <h3>Other Findings (é¸å¡«)</h3>
                <label>Enlarged lymph nodes, location <input type="text" class="form-input" id="other_lymph" placeholder="..."></label>
                <label>Coronary artery calcification <input type="text" class="form-input" id="other_coronary" placeholder="..."></label>
                <label>Other significant abnormal chest findings <input type="text" class="form-input" id="other_chest" placeholder="..."></label>
                <label>Other significant abnormal abdominal or neck findings <input type="text" class="form-input" id="other_abnormal" placeholder="..."></label>
            </section>
            <hr>
            <section>
                <h3>Overall recommendation</h3>
                <fieldset>
                    <legend>Lung-RADS v2022 Category Descriptor</legend>
                    <label><input type="radio" name="category" value="0" onchange="handleCategoryChange()"> Category 0: Incomplete.</label>
                    <div id="cat_0_details" class="nested-section">
                        <label><input type="checkbox" id="cat_0_prior" onchange="updateCat0Radio()"> Prior chest CT examination being located for comparison.</label>
                        <label><input type="checkbox" id="cat_0_unevaluated" onchange="updateCat0Radio()"> Part or all of lungs cannot be evaluated.</label>
                        <label><input type="checkbox" id="cat_0_inflammatory" onchange="updateCat0Radio()"> Findings suggestive of an inflammatory or infectious process.</label>
                    </div>
                    <label><input type="radio" name="category" value="1" onchange="handleCategoryChange()"> Category 1: Negative.</label>
                    <label><input type="radio" name="category" value="2" onchange="handleCategoryChange()"> Category 2: Benign - Based on imaging features or indolent behavior.</label>
                    <label><input type="radio" name="category" value="3" onchange="handleCategoryChange()"> Category 3: Probably Benign - Based on imaging features or behavior.</label>
                    <label><input type="radio" name="category" value="4A" onchange="handleCategoryChange()"> Category 4A: Suspicious.</label>
                    <label><input type="radio" name="category" value="4B" onchange="handleCategoryChange()"> Category 4B: Very suspicious.</label>
                    <label><input type="radio" name="category" value="4X" onchange="handleCategoryChange()"> Category 4X: Category 3 or 4 nodules with additional features or imaging findings that increase suspicion for lung cancer.</label>
                </fieldset>
            </section>
            <hr>
            <section>
                <h3>(é¸å¡«)</h3>
                <label><input type="checkbox" id="modifier_s"> Modifier S: May add to category 0-4 for clinically significant or potentially clinically significant findings unrelated to lung cancer.</label>
                <label><input type="checkbox" id="refer_opd"> è«‹è‡³é–€è¨ºå°±è¨º</label>
            </section>
        </article>
    </main>

    <footer class="sticky-footer" id="sticky-footer">
        <div class="footer-container">
            <strong>æº–å‚™å¥½å¾Œé»æ“Šè¤‡è£½</strong>
            <div>
                <button id="copy_simple_button" onclick="validateAndCopy('simple')" class="secondary">è¤‡è£½ç°¡æ˜“å ±å‘Š</button>
                <button id="copy_button" onclick="validateAndCopy('full')">è¤‡è£½å®Œæ•´å ±å‘Š</button>
            </div>
        </div>
    </footer>

    <dialog id="report_modal" onclick="closeModalOnBackdrop(event)"><article><header><a href="#close" aria-label="Close" class="close" data-target="report_modal" onclick="toggleModal(event)"></a><span id="modal_title">å ±å‘Šå…§å®¹ (å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿)</span></header><pre id="modal_output"></pre><footer><button data-target="report_modal" onclick="toggleModal(event)">é—œé–‰</button></footer></article></dialog>
    <dialog id="delete_modal" onclick="closeModalOnBackdrop(event)"><article><header>ç¢ºèªåˆªé™¤</header><p>ç¢ºå®šè¦åˆªé™¤æ­¤çµç¯€å—ï¼Ÿ<br>å¾Œé¢çš„çµç¯€è³‡æ–™å°‡æœƒå¾€å‰éè£œã€‚</p><div class="modal-actions"><button class="secondary" onclick="closeModal('delete_modal')">å–æ¶ˆ</button><button class="contrast" onclick="confirmDelete()">ç¢ºå®šåˆªé™¤</button></div></article></dialog>
    <dialog id="about_modal" onclick="closeModalOnBackdrop(event)"><article><header><a href="#close" aria-label="Close" class="close" data-target="about_modal" onclick="toggleModal(event)"></a><strong>About this project</strong></header><p><strong>Lung-RADS v2022 å ±å‘Šç”¢ç”Ÿå™¨</strong><br>é€™æ˜¯ä¸€å€‹å”åŠ©æ”¾å°„ç§‘é†«å¸«å¿«é€Ÿç”¢ç”Ÿ Lung-RADS v2022 çµæ§‹åŒ–å ±å‘Šçš„å·¥å…·ã€‚</p><ul><li><strong>ä½œè€…:</strong> è”¡ä¾é” / é™½äº¤å¤§é™„é†«æ”¾å°„ç§‘é†«å¸«</li><li><strong>License:</strong> MIT</li><li><strong>Source Code:</strong> <a href="https://github.com/tsaiid/structured-reporting-web-tools" target="_blank">GitHub</a></li></ul><footer><button class="secondary" data-target="about_modal" onclick="toggleModal(event)">é—œé–‰</button></footer></article></dialog>

    <script>
        const $ = id => document.getElementById(id);
        const getValue = id => $(id).value.trim();
        const isChecked = id => $(id).checked;
        const getRadio = name => document.querySelector(`input[name="${name}"]:checked`)?.value || "";
        const cb = (id, text) => `${isChecked(id) ? '[+]' : '[ ]'} ${text}\n`;
        const rb = (name, value, text) => `${getRadio(name) === value ? '[+]' : '[ ]'} ${text}\n`;
        const rb_inline = (name, value, text) => `${getRadio(name) === value ? '[+]' : '[ ]'} ${text}`;
        const cb_inline = (id, text) => `${isChecked(id) ? '[+]' : '[ ]'} ${text}`;
        const txt = (id, prefix = '', suffix = '') => { const val = getValue(id); return `${prefix}${val || '_'}${suffix}`; };
        const cb_se_im = (id_check, text, id_se, id_im, isSimple) => {
            if (isSimple && !isChecked(id_check)) return "";
            if (isChecked(id_check)) {
                const se = getValue(id_se) ? ` SE: ${getValue(id_se)}` : ' SE: _';
                const im = getValue(id_im) ? `, IM: ${getValue(id_im)}` : ', IM: _';
                return `[+] ${text} (${se}${im})\n`;
            }
            return `[ ] ${text} (é¸å¡« SE: , IM:  )\n`;
        };

        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('num-only')) {
                let val = e.target.value;
                val = val.replace(/[^0-9.]/g, '');
                const parts = val.split('.');
                if (parts.length > 2) { val = parts[0] + '.' + parts.slice(1).join(''); }
                e.target.value = val;
            }
        });

        // Theme è¨˜æ†¶åŠŸèƒ½èˆ‡åˆ‡æ›é‚è¼¯
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const toggle = document.getElementById('theme_toggle');

            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
                if (toggle) toggle.checked = (savedTheme === 'dark');
            } else {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const initialTheme = prefersDark ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', initialTheme);
                if (toggle) toggle.checked = prefersDark;
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            const toggle = document.getElementById('theme_toggle');
            if (toggle) toggle.checked = (newTheme === 'dark');
        }

        initTheme();

        function toggleSection(elementId, show) { const el = $(elementId); if (show) el.classList.remove('hidden'); else el.classList.add('hidden'); }
        function handleNoduleGte6Change(isChecked) { toggleSection('nodule_details', isChecked); if (isChecked) { const radio = document.querySelector('input[name="total_nodules"]:checked'); if (!radio) { const r1 = document.querySelector('input[name="total_nodules"][value="1"]'); if (r1) { r1.checked = true; updateNoduleCount(); } } } }
        function toggleSolidPart(containerId, densityValue) { const container = $(containerId); if (densityValue === 'part-solid') container.classList.remove('hidden'); else container.classList.add('hidden'); }
        function updateAirwayParent() { $('airway_proximal').checked = isChecked('airway_secretions') || isChecked('airway_baseline') || isChecked('airway_stable'); }
        function clearAirwayChildren(parentIsChecked) { if (!parentIsChecked) { $('airway_secretions').checked = false; $('airway_baseline').checked = false; $('airway_stable').checked = false; } }
        function handleCategoryChange() { if (getRadio('category') !== '0') { $('cat_0_prior').checked = false; $('cat_0_unevaluated').checked = false; $('cat_0_inflammatory').checked = false; } }
        function updateCat0Radio() { if (isChecked('cat_0_prior') || isChecked('cat_0_unevaluated') || isChecked('cat_0_inflammatory')) { document.querySelector('input[name="category"][value="0"]').checked = true; } }
        function updateNoduleCount() {
            const val = getRadio('total_nodules');
            const show = (id, enable) => { const el = $(id); const checkId = id.replace('block_', '') + '_enable'; const checkEl = $(checkId); if (enable) { el.classList.remove('hidden'); if (checkEl) checkEl.checked = true; } else { el.classList.add('hidden'); if (checkEl) checkEl.checked = false; } };
            let count = 0; if (val === '1') count = 1; if (val === '2') count = 2; if (val === '3') count = 3; if (val === '>=4') count = 4;
            show('block_n1', count >= 1); show('block_n2', count >= 2); show('block_n3', count >= 3); show('block_else', count >= 4);
        }

        let noduleToDelete = null;
        function promptDelete(index) { noduleToDelete = index; openModal('delete_modal'); }
        function confirmDelete() {
            if (noduleToDelete === null) return;
            const index = noduleToDelete;
            closeModal('delete_modal');
            const radio = document.querySelector('input[name="total_nodules"]:checked');
            if (!radio) return;
            let currentCountStr = radio.value;
            let currentCount = 0;
            if(currentCountStr === '1') currentCount = 1; else if(currentCountStr === '2') currentCount = 2; else if(currentCountStr === '3') currentCount = 3; else if(currentCountStr === '>=4') currentCount = 4;
            for (let i = index; i < 3; i++) {
                let next = i + 1;
                $(`n${i}_size`).value = $(`n${next}_size`).value;
                $(`n${i}_solid_part`).value = $(`n${next}_solid_part`).value;
                $(`n${i}_se`).value = $(`n${next}_se`).value;
                $(`n${i}_im`).value = $(`n${next}_im`).value;
                let nextDensity = getRadio(`n${next}_density`);
                if(nextDensity) { let r = document.querySelector(`input[name="n${i}_density"][value="${nextDensity}"]`); if(r) r.checked = true; toggleSolidPart(`n${i}_solid_container`, nextDensity); } else { document.querySelectorAll(`input[name="n${i}_density"]`).forEach(el => el.checked = false); toggleSolidPart(`n${i}_solid_container`, ''); }
                let nextLobe = getRadio(`n${next}_lobe`); if(nextLobe) { let r = document.querySelector(`input[name="n${i}_lobe"][value="${nextLobe}"]`); if(r) r.checked = true; } else { document.querySelectorAll(`input[name="n${i}_lobe"]`).forEach(el => el.checked = false); }
                let nextStatus = getRadio(`n${next}_status`); if(nextStatus) { let r = document.querySelector(`input[name="n${i}_status"][value="${nextStatus}"]`); if(r) r.checked = true; } else { document.querySelectorAll(`input[name="n${i}_status"]`).forEach(el => el.checked = false); }
            }
            let clearIndex = currentCount; if (currentCount >= 4) clearIndex = 3;
            if (clearIndex <= 3) { $(`n${clearIndex}_size`).value = ''; $(`n${clearIndex}_solid_part`).value = ''; $(`n${clearIndex}_se`).value = ''; $(`n${clearIndex}_im`).value = ''; document.querySelectorAll(`input[name="n${clearIndex}_density"]`).forEach(el => el.checked = false); toggleSolidPart(`n${clearIndex}_solid_container`, ''); document.querySelectorAll(`input[name="n${clearIndex}_lobe"]`).forEach(el => el.checked = false); document.querySelectorAll(`input[name="n${clearIndex}_status"]`).forEach(el => el.checked = false); }
            if (currentCount === 1) { document.querySelectorAll('input[name="total_nodules"]').forEach(el => el.checked = false); const mainCheck = $('nodule_gte6'); if (mainCheck) { mainCheck.checked = false; handleNoduleGte6Change(false); } $('block_n1').classList.add('hidden'); $('n1_enable').checked = false; } else { let newCount = currentCount - 1; let radioVal = String(newCount); if (newCount >= 4) radioVal = '>=4'; const r = document.querySelector(`input[name="total_nodules"][value="${radioVal}"]`); if(r) { r.checked = true; updateNoduleCount(); } }
            autoCalculateCategory(); noduleToDelete = null;
        }

        function handlePriorDateInput() { const hasText = getValue('prior_date').length > 0; const noPriorCheckbox = $('no_prior'); if (hasText) { noPriorCheckbox.checked = false; noPriorCheckbox.disabled = true; } else { noPriorCheckbox.disabled = false; } updateNoduleStatusBasedOnPrior(hasText); }
        function togglePriorDate(isNoPriorChecked) { const priorDateInput = $('prior_date'); if (isNoPriorChecked) { priorDateInput.value = ''; priorDateInput.disabled = true; updateNoduleStatusBasedOnPrior(false, true); } else { priorDateInput.disabled = false; updateNoduleStatusBasedOnPrior(false, false); } }
        function updateNoduleStatusBasedOnPrior(hasDate, isNoPriorChecked = false) { for (let i = 1; i <= 3; i++) { const noPriorRadio = document.querySelector(`input[name="n${i}_status"][value="no prior"]`); if (!noPriorRadio) continue; if (hasDate) { noPriorRadio.disabled = true; if (noPriorRadio.checked) noPriorRadio.checked = false; } else { if (isNoPriorChecked || !getValue('prior_date')) { noPriorRadio.disabled = false; const anyChecked = document.querySelector(`input[name="n${i}_status"]:checked`); if (!anyChecked) noPriorRadio.checked = true; } else { noPriorRadio.disabled = false; } } } }

        const openModal = (target) => $(target)?.showModal();
        const closeModal = (target) => $(target)?.close();
        const toggleModal = (event) => { event.preventDefault(); const modalId = event.currentTarget.dataset.target; const modal = $(modalId); modal.open ? closeModal(modalId) : openModal(modalId); };
        function closeModalOnBackdrop(event) { if (event.target.tagName === 'DIALOG') { event.target.close(); } }
        window.onscroll = function() { const footer = $('sticky-footer'); if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 50) { footer.classList.add('visible'); } else { footer.classList.remove('visible'); } };

        function validateForm() { document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error')); let errors = []; if (!getValue('ctdi')) errors.push({id: 'ctdi'}); if (!getValue('dlp')) errors.push({id: 'dlp'}); const priorDate = getValue('prior_date'); const noPrior = isChecked('no_prior'); if (!priorDate && !noPrior) { errors.push({id: 'prior_date'}); } if (isChecked('nodule_gte6')) { const totalNodules = getRadio('total_nodules'); let count = 0; if(totalNodules === '1') count = 1; else if(totalNodules === '2') count = 2; else if(totalNodules === '3') count = 3; else if(totalNodules === '>=4') count = 3; for (let i = 1; i <= count; i++) { if (!getValue(`n${i}_size`)) errors.push({id: `n${i}_size`}); const density = getRadio(`n${i}_density`); if (!density) { errors.push({id: `n${i}_density_group`}); } else if (density === 'part-solid') { if (!getValue(`n${i}_solid_part`)) errors.push({id: `n${i}_solid_part`}); } if (!getRadio(`n${i}_lobe`)) errors.push({id: `n${i}_lobe_group`}); if (!getRadio(`n${i}_status`)) errors.push({id: `n${i}_status_group`}); } } if (errors.length > 0) { const firstId = errors[0].id; const el = $(firstId); errors.forEach(e => { const elem = $(e.id); if(elem) elem.classList.add('input-error'); }); if(el) { el.scrollIntoView({behavior: 'smooth', block: 'center'}); if(el.tagName === 'INPUT') el.focus(); } return false; } return true; }
        function validateAndCopy(type) { if (!validateForm()) return; if (type === 'full') generateAndCopyFull(); else generateAndCopySimple(); }

        function generateNoduleText(n, isSimple) { const enabled = isChecked(`n${n}_enable`); if (isSimple && !enabled) return ""; const isPopulated = enabled; let text = `  ${isPopulated ? '[+]' : '[ ]'} Lung nodule ${n} (size, character and location)\n`; text += `    Entire Nodule: ${isPopulated ? txt(`n${n}_size`, '', ' mm') : '_ mm'}\n`; const density = isPopulated ? getRadio(`n${n}_density`) : ''; text += `    Density: ${density === 'non-solid' ? '[+]' : '[ ]'} non-solid  `; text += `${density === 'part-solid' ? '[+]' : '[ ]'} part-solid (solid part: ${density === 'part-solid' ? txt(`n${n}_solid_part`, '', ' mm') : '___ mm'}) `; text += `${density === 'solid' ? '[+]' : '[ ]'} solid\n`; text += `    Lobe: (SE:${isPopulated ? txt(`n${n}_se`) : '_'}, IM:${isPopulated ? txt(`n${n}_im`) : '_'}) `; text += `${isPopulated ? rb_inline(`n${n}_lobe`, 'RUL', 'RUL') : '[ ] RUL'} `; text += `${isPopulated ? rb_inline(`n${n}_lobe`, 'RML', 'RML') : '[ ] RML'} `; text += `${isPopulated ? rb_inline(`n${n}_lobe`, 'RLL', 'RLL') : '[ ] RLL'} `; text += `${isPopulated ? rb_inline(`n${n}_lobe`, 'LUL', 'LUL') : '[ ] LUL'} `; text += `${isPopulated ? rb_inline(`n${n}_lobe`, 'LLL', 'LLL') : '[ ] LLL'}\n`; text += `    The nodule is ${isPopulated ? rb_inline(`n${n}_status`, 'unchanged', 'unchanged') : '[ ] unchanged'} `; text += `${isPopulated ? rb_inline(`n${n}_status`, 'enlarging', 'enlarging (>1.5 mm)') : '[ ] enlarging (>1.5 mm)'} `; text += `${isPopulated ? rb_inline(`n${n}_status`, 'newly found', 'newly found (â‰§4 mm)') : '[ ] newly found (â‰§4 mm)'} `; text += `${isPopulated ? rb_inline(`n${n}_status`, 'no prior', 'No prior chest CT comparison') : '[ ] No prior chest CT comparison'}`; return text; }
        function generateReportText(isSimple = false) { let report = ""; const add = (text) => { report += text; }; const addLine = (condition, lineGenerator) => { if (!isSimple || condition) add(lineGenerator()); }; const addLineCb = (id, text) => addLine(isChecked(id), () => cb(id, text)); report += `LDCT Quality: ${rb_inline('quality', 'Good', 'Good')} ${rb_inline('quality', 'Acceptable', 'Acceptable')} ${rb_inline('quality', 'Not Acceptable', 'Not Acceptable')}\n`; report += `CTDIvol: ${txt('ctdi')} mGy Total DLP: ${txt('dlp')} mGy*cm\n`; report += `In comparison with the prior CT, Date (Y/M/D) ${txt('prior_date')} ${cb('no_prior', 'No prior chest CT available')}`; report += "\nLung nodule findings related to cancer screening\n"; report += "è©³ç´°è¦ç¯„è«‹åƒé–± Lung-RADS v2022\n\n"; addLineCb('no_nodule', 'No lung nodule'); addLineCb('benign_features', 'Nodule with benign features.'); addLine(isChecked('nodule_lt6'), () => cb_se_im('nodule_lt6', 'Lung nodule(s) (<6mm)', 'lt6_se', 'lt6_im')); addLineCb('juxtapleural', 'Juxtapleural nodule.'); const isGte6Checked = isChecked('nodule_gte6'); if (isSimple) { if (isGte6Checked) { report += "[+] Lung nodule(s) (â‰§6mm or enlarging>1.5mm or newâ‰§4mm): total number "; report += `${rb_inline('total_nodules', '1', '1')} ${rb_inline('total_nodules', '2', '2')} ${rb_inline('total_nodules', '3', '3')} ${rb_inline('total_nodules', '>=4', 'â‰¥4')}`; report += ", and described as followings:\n"; report += generateNoduleText(1, true) + (isChecked('n1_enable') ? "\n\n" : ""); report += generateNoduleText(2, true) + (isChecked('n2_enable') ? "\n\n" : ""); report += generateNoduleText(3, true) + (isChecked('n3_enable') ? "\n\n" : ""); } } else { report += `${isGte6Checked ? '[+]' : '[ ]'} Lung nodule(s) (â‰§6mm or enlarging>1.5mm or newâ‰§4mm): total number `; report += `${rb_inline('total_nodules', '1', '1')} ${rb_inline('total_nodules', '2', '2')} ${rb_inline('total_nodules', '3', '3')} ${rb_inline('total_nodules', '>=4', 'â‰¥4')}`; report += ", and described as followings:\n"; report += generateNoduleText(1, false) + "\n\n"; report += generateNoduleText(2, false) + "\n\n"; report += generateNoduleText(3, false) + "\n\n"; } const showElse = (getRadio('total_nodules') === '>=4'); const elseLobesChecked = isChecked('else_rul') || isChecked('else_rml') || isChecked('else_rll') || isChecked('else_lul') || isChecked('else_lll'); if (isSimple) { if (isGte6Checked && showElse) { report += `  [+] Lung nodules else `; report += `${cb_inline('else_rul', 'RUL')} `; report += `${cb_inline('else_rml', 'RML')} `; report += `${cb_inline('else_rll', 'RLL')} `; report += `${cb_inline('else_lul', 'LUL')} `; report += `${cb_inline('else_lll', 'LLL')} `; report += `(SE:${txt('else_se')}, IM:${txt('else_im')})\n\n`; } } else { report += `  ${elseLobesChecked && showElse ? '[+]' : '[ ]'} Lung nodules else `; report += `${showElse ? cb_inline('else_rul', 'RUL') : '[ ] RUL'} `; report += `${showElse ? cb_inline('else_rml', 'RML') : '[ ] RML'} `; report += `${showElse ? cb_inline('else_rll', 'RLL') : '[ ] RLL'} `; report += `${showElse ? cb_inline('else_lul', 'LUL') : '[ ] LLL'} `; report += `${showElse ? cb_inline('else_lll', 'LLL') : '[ ] LLL'} `; report += `(SE:${showElse ? txt('else_se') : '_'}, IM:${showElse ? txt('else_im') : '_'})\n\n`; } let airwayChecked = isChecked('airway_subsegmental') || isChecked('airway_proximal'); if (!isSimple || airwayChecked) { report += `${airwayChecked ? '[+]' : '[ ]'} Airway nodule\n`; addLine(true, () => `  ${cb('airway_subsegmental', 'Subsegmental (Category 2)')}`); addLine(true, () => `  ${cb('airway_proximal', 'Segmental or more proximal')}`); addLine(true, () => `    ${cb('airway_secretions', 'Favors secretions (Category 2)')}`); addLine(true, () => `    ${cb('airway_baseline', 'At baseline (Category 4A)')}`); addLine(true, () => `    ${cb('airway_stable', 'Stable or growing (Category 4B)')}`); report += "\n"; } let cystChecked = isChecked('cyst_3') || isChecked('cyst_4a') || isChecked('cyst_4b'); if (!isSimple || cystChecked) { const getCystString = (cat_id, cat_name, se_id, im_id, isSimple) => { if (isSimple && !isChecked(cat_id)) return ""; let line = `  ${cb(cat_id, `Category ${cat_name}. Lobe: (SE: ${txt(se_id)}, IM: ${txt(im_id)}) `)}`; line = line.trimEnd(); line += ` ${cb_inline(cat_id + '_rul', 'RUL')}`; line += ` ${cb_inline(cat_id + '_rml', 'RML')}`; line += ` ${cb_inline(cat_id + '_rll', 'RLL')}`; line += ` ${cb_inline(cat_id + '_lul', 'LUL')}`; line += ` ${cb_inline(cat_id + '_lll', 'LLL')}\n`; return line; }; report += `${cystChecked ? '[+]' : '[ ]'} Atypical pulmonary cyst\n`; add(getCystString('cyst_3', '3', 'cyst_3_se', 'cyst_3_im', isSimple)); add(getCystString('cyst_4a', '4A', 'cyst_4a_se', 'cyst_4a_im', isSimple)); add(getCystString('cyst_4b', '4B', 'cyst_4b_se', 'cyst_4b_im', isSimple)); report += "\n"; } addLineCb('metastases', 'The pattern of lung nodules has a higher probability of metastases'); let otherLungChecked = isChecked('other_emphysema') || isChecked('other_bronchiectasis') || isChecked('other_bronchitis') || isChecked('other_treeinbud') || isChecked('other_centrilobular') || isChecked('other_tb') || isChecked('other_ild') || isChecked('other_other_lung_check'); if (!isSimple || otherLungChecked) { report += "\n----\nOther Lung Findings (é¸å¡«)\n"; let line1 = "", line2 = ""; if (!isSimple || isChecked('other_emphysema')) line1 += `${cb_inline('other_emphysema', 'Emphysema')} `; if (!isSimple || isChecked('other_bronchiectasis')) line1 += `${cb_inline('other_bronchiectasis', 'Bronchiectasis')} `; if (!isSimple || isChecked('other_bronchitis')) line1 += `${cb_inline('other_bronchitis', 'Bronchitis/bronchiolitis')} `; if (!isSimple || isChecked('other_treeinbud')) line1 += `${cb_inline('other_treeinbud', 'Tree-in-bud pattern')}`; if (!isSimple || isChecked('other_centrilobular')) line2 += `${cb_inline('other_centrilobular', 'Centrilobular nodules')} `; if (!isSimple || isChecked('other_tb')) line2 += `${cb_inline('other_tb', 'Old pulmonary TB')} `; if (!isSimple || isChecked('other_ild')) line2 += `${cb_inline('other_ild', 'Interstitial lung disease (ILD)')} `; if (!isSimple || isChecked('other_other_lung_check')) line2 += `${cb_inline('other_other_lung_check', `Other ${txt('other_other_lung_text')}`)}`; if (line1.trim() !== "") report += line1.trimEnd() + "\n"; if (line2.trim() !== "") report += line2.trimEnd() + "\n"; } let otherFindingsChecked = getValue('other_lymph') || getValue('other_coronary') || getValue('other_chest') || getValue('other_abnormal'); if (!isSimple || otherFindingsChecked) { report += "\nOther Findings (é¸å¡«)\n"; const addOtherFinding = (id, text) => { const val = getValue(id); if (isSimple && !val) return; const mark = val ? '[+]' : '[ ]'; const content = val ? `: ${val}` : ''; report += `${mark} ${text}${content}\n`; }; addOtherFinding('other_lymph', 'Enlarged lymph nodes, location'); addOtherFinding('other_coronary', 'Coronary artery calcification'); addOtherFinding('other_chest', 'Other significant abnormal chest findings'); addOtherFinding('other_abnormal', 'Other significant abnormal abdominal or neck findings in this chest CT scan'); } report += "\n----\nOverall recommendation\n"; report += "Lung-RADS v2022 Category Descriptor\n"; report += `  ${rb_inline('category', '0', 'Category 0: Incomplete.')}\n`; report += `    ${cb('cat_0_prior', 'Prior chest CT examination being located for comparison.')}`; report += `    ${cb('cat_0_unevaluated', 'Part or all of lungs cannot be evaluated.')}`; report += `    ${cb('cat_0_inflammatory', 'Findings suggestive of an inflammatory or infectious process.')}`; report += `  ${rb_inline('category', '1', 'Category 1: Negative.')}\n`; report += `  ${rb_inline('category', '2', 'Category 2: Benign - Based on imaging features or indolent behavior.')}\n`; report += `  ${rb_inline('category', '3', 'Category 3: Probably Benign - Based on imaging features or behavior.')}\n`; report += `  ${rb_inline('category', '4A', 'Category 4A: Suspicious.')}\n`; report += `  ${rb_inline('category', '4B', 'Category 4B: Very suspicious.')}\n`; report += `  ${rb_inline('category', '4X', 'Category 4X: Category 3 or 4 nodules with additional features or imaging findings that increase suspicion for lung cancer.')}\n`; if (!isSimple || isChecked('modifier_s') || isChecked('refer_opd')) { report += "\n----\n(é¸å¡«)\n"; addLineCb('modifier_s', 'Modifier S: May add to category 0-4 for clinically significant or potentially clinically significant findings unrelated to lung cancer.'); addLineCb('refer_opd', 'è«‹è‡³é–€è¨ºå°±è¨º'); } return report.replace(/\n\n\n/g, '\n\n'); }
        function copyToClipboardAndShowModal(report, buttonId, title) { navigator.clipboard.writeText(report).then(() => { $('modal_output').textContent = report; $('modal_title').textContent = title + " (å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿)"; openModal('report_modal'); const btn = $(buttonId); const originalText = (buttonId === 'copy_button') ? 'è¤‡è£½å®Œæ•´å ±å‘Š' : 'è¤‡è£½ç°¡æ˜“å ±å‘Š'; btn.innerHTML = "âœ“ å·²è¤‡è£½ï¼"; btn.disabled = true; setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000); }).catch(err => { console.error('è¤‡è£½å¤±æ•—: ', err); alert('è¤‡è£½å¤±æ•—ã€‚è«‹æª¢æŸ¥æ‚¨çš„ç€è¦½å™¨æ¬Šé™è¨­å®šã€‚'); }); }
        function generateAndCopyFull() { const report = generateReportText(false); copyToClipboardAndShowModal(report, 'copy_button', 'å®Œæ•´å ±å‘Šå…§å®¹'); }
        function generateAndCopySimple() { const report = generateReportText(true); copyToClipboardAndShowModal(report, 'copy_simple_button', 'ç°¡æ˜“å ±å‘Šå…§å®¹'); }
        function autoCalculateCategory() {
            const CAT_4B = 6; const CAT_4A = 5; const CAT_3 = 4; const CAT_2 = 3; const CAT_1 = 2; const CAT_0 = 10;
            let currentScore = 0;
            const setScore = (score) => { if (score > currentScore) currentScore = score; };

            if (isChecked('cat_0_prior') || isChecked('cat_0_unevaluated') || isChecked('cat_0_inflammatory')) {
                setScore(CAT_0);
            }
            if (currentScore === CAT_0) { checkCategoryRadio("0"); return; }

            if (isChecked('airway_stable')) setScore(CAT_4B);
            if (isChecked('cyst_4b')) setScore(CAT_4B);

            for (let i = 1; i <= 3; i++) {
                if (!isChecked('nodule_gte6') || !isChecked(`n${i}_enable`)) continue;
                let size = parseFloat(getValue(`n${i}_size`)) || 0;
                let density = getRadio(`n${i}_density`);
                let solidPart = parseFloat(getValue(`n${i}_solid_part`)) || 0;
                let status = getRadio(`n${i}_status`);

                if (density === 'solid') {
                    if (size >= 15) setScore(CAT_4B);
                    if ((status === 'newly found' || status === 'enlarging') && size >= 8) setScore(CAT_4B);
                } else if (density === 'part-solid') {
                    if (solidPart >= 8) setScore(CAT_4B);
                    if ((status === 'newly found' || status === 'enlarging') && solidPart >= 4) setScore(CAT_4B);
                }
            }

            if (currentScore < CAT_4B) {
                if (isChecked('airway_baseline')) setScore(CAT_4A);
                if (isChecked('cyst_4a')) setScore(CAT_4A);
                for (let i = 1; i <= 3; i++) {
                    if (!isChecked('nodule_gte6') || !isChecked(`n${i}_enable`)) continue;
                    let size = parseFloat(getValue(`n${i}_size`)) || 0;
                    let density = getRadio(`n${i}_density`);
                    let solidPart = parseFloat(getValue(`n${i}_solid_part`)) || 0;
                    let status = getRadio(`n${i}_status`);
                    if (density === 'solid') {
                        if (size >= 8 && size < 15) setScore(CAT_4A);
                        if (status === 'enlarging' && size < 8) setScore(CAT_4A);
                        if (status === 'newly found' && size >= 6 && size < 8) setScore(CAT_4A);
                    } else if (density === 'part-solid') {
                        if (size >= 6 && solidPart >= 6 && solidPart < 8) setScore(CAT_4A);
                        if ((status === 'newly found' || status === 'enlarging') && solidPart < 4) setScore(CAT_4A);
                    }
                }
            }

            if (currentScore < CAT_4A) {
                if (isChecked('cyst_3')) setScore(CAT_3);
                for (let i = 1; i <= 3; i++) {
                    if (!isChecked('nodule_gte6') || !isChecked(`n${i}_enable`)) continue;
                    let size = parseFloat(getValue(`n${i}_size`)) || 0;
                    let density = getRadio(`n${i}_density`);
                    let solidPart = parseFloat(getValue(`n${i}_solid_part`)) || 0;
                    let status = getRadio(`n${i}_status`);
                    if (density === 'solid') {
                        if (size >= 6 && size < 8) setScore(CAT_3);
                        if (status === 'newly found' && size >= 4 && size < 6) setScore(CAT_3);
                    } else if (density === 'part-solid') {
                        if (size >= 6 && solidPart < 6) setScore(CAT_3);
                        if (status === 'newly found' && size < 6) setScore(CAT_3);
                    } else if (density === 'non-solid') {
                        if (size >= 30 && (status === 'no prior' || status === 'newly found')) {
                            setScore(CAT_3);
                        }
                    }
                }
            }

            if (currentScore < CAT_3) {
                if (isChecked('nodule_lt6')) setScore(CAT_2);
                if (isChecked('juxtapleural')) setScore(CAT_2);
                if (isChecked('airway_subsegmental') || isChecked('airway_secretions')) setScore(CAT_2);
                for (let i = 1; i <= 3; i++) {
                    if (!isChecked('nodule_gte6') || !isChecked(`n${i}_enable`)) continue;
                    let size = parseFloat(getValue(`n${i}_size`)) || 0;
                    let density = getRadio(`n${i}_density`);
                    let status = getRadio(`n${i}_status`);
                    if (density === 'solid') {
                        if (size < 6) setScore(CAT_2);
                        if (status === 'newly found' && size < 4) setScore(CAT_2);
                    } else if (density === 'part-solid') {
                        if (size < 6) setScore(CAT_2);
                    } else if (density === 'non-solid') { setScore(CAT_2); }
                }
            }

            if (currentScore < CAT_2) {
                if (isChecked('no_nodule') || isChecked('benign_features')) setScore(CAT_1);
            }

            if (currentScore === CAT_4B) checkCategoryRadio("4B");
            else if (currentScore === CAT_4A) checkCategoryRadio("4A");
            else if (currentScore === CAT_3) checkCategoryRadio("3");
            else if (currentScore === CAT_2) checkCategoryRadio("2");
            else if (currentScore === CAT_1) checkCategoryRadio("1");
        }

        function checkCategoryRadio(val) {
            const radio = document.querySelector(`input[name="category"][value="${val}"]`);
            if (radio && !radio.checked) radio.checked = true;
        }

        document.querySelector('main').addEventListener('change', autoCalculateCategory);
        document.querySelector('main').addEventListener('input', autoCalculateCategory);
    </script>
</body>
</html>